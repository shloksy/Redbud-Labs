<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QTools: Unity Mock Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="ql-preview.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="ql-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
  <div id="projectlogo">
    <a href="https://www.state-machine.com" title="Quantum Leaps"><img alt="Logo" src="logo_ql.png"/></a>
  </div>
   <div id="projectname">
    QTools
    &nbsp;<span id="projectnumber">7.2.1</span>
   </div>
   <div id="projectbrief">Collection of Host-Based Tools</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('qutest_mock.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Unity Mock Example </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><span class="prev_button"><a class="el" href="qutest_unity.html">Basic Unity Example</a></span><span class="next_button"><a class="el" href="qutest_qhsm.html">Hierarchical State Machine Example</a></span></p>
<p>This example is loosely based on <a href="https://www.electronvector.com/about" target="_blank" class="extern"><b>Matt Chernosky's</b></a> video blog post <a href="https://www.electronvector.com/blog/test-driving-with-mocks-instead-of-hardware" target="_blank" class="extern"><b>"Test-driving with mocks instead of hardware"</b></a>. In this video blog, Matt presents a technique called the <a href="https://en.wikipedia.org/wiki/Mock_object" target="_blank" class="extern"><b>mock object</b></a>, which in the traditional unit testing approach is needed to verify complex, multi-stage interactions between the CUT and the collaborator impersonated by the mock object. </p>
<dl class="section note"><dt>Note</dt><dd>To better understand this QUTest example, it is highly recommended to watch <a href="https://vimeo.com/256590562" target="_blank" class="extern"><b>Chernosky's video blog</b></a>.</dd></dl>
<p>The main purpose of this example is to show the traditional approach (with the mock object) and contrast it with the much simpler solution enabled by the QUTest approach. Of course, to make comparisons meaningful, both approaches test the <a class="el" href="qutest_mock.html#qutest_mock-cut">same CUT</a>.</p>
<dl class="section note"><dt>Note</dt><dd>Because of the different design philosophy of QUTest, which is <em>not</em> based on xUnit, the classic "mock object" is actually not needed and can be replaced with a simpler "spy" <a href="https://en.wikipedia.org/wiki/Test_double" target="_blank" target="_blank" class="extern"><b>test double</b></a>. To dynamically alter the behavior of this "spy" test double, this example applies <a class="el" href="qutest_fixture.html#qutest_fixture-probe">QUTest Test Probes</a>. Test Probes can be changed interactively from the <a class="el" href="qutest_mock.html#qutest_mock-script">test script</a>.</dd></dl>
<dl class="section remark"><dt>Remarks</dt><dd>Since the <a class="el" href="qutest_mock.html#qutest_mock-cut">CUT</a> is in C, the Mock Unity example is only available in the <a href="https://www.state-machine.com/qpc"><b>QP/C framework</b></a> (and is <b>not</b> available in the <a href="https://www.state-machine.com/qpcpp">QP/C++ framework</a>).<br  />
 <br  />
 This simple example runs QUTest tests on the host (Windows, Linux, or macOS) for both Unity and QUTest. The QUTest version also runs on embedded boards (NUCLEO-L053R8 from ST, EFM32 Pearl-Gecko board from Silicon Labs and TivaC LaunchPad from Texas Instruments and ). The instructions for building and running the code on the embedded boards are located at the end of this lesson. <br  />
 <img src="platforms.png" alt="" class="inline" title="Targets for this example"/>    </dd></dl>
<h1><a class="anchor" id="qutest_mock-cut"></a>
Code Under Test (CUT)</h1>
<p>The CUT in this example implements a simple bar of 5 LEDs that displays percentage, as shown in the animation below. The "LedBar device" interacts with the discrete LEDs by turning them on and off to achieve the desired effect. The main objective of this example is to demonstrate how to verify the <b>collaboration</b> with the discrete LEDs, even without the actual hardware.</p>
<div class="image">
<img src="ledbar5.gif" alt=""/>
<div class="caption">
Bar of 5 LEDs displaying the percentage</div></div>
    <p>The LedBar CUT is located in the file <span class="img file_c"><code>LedBar.c</code></span> in the directory <span class="img folder"><code>qpc\examples\qutest\unity_ledbar\src</code></span>. The CUT consists of just one function <code>LedBar_setPercent()</code>, which turns the individual LEDs on and off such that they display the desired <code>percent</code> parameter. The function <code>LedBar_setPercent()</code> returns the total power consumption (in microwatts) of all LEDs that are turned on.</p>
<p><a class="anchor" id="qutest_tut_mock-cut"></a></p><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="preprocessor">#include &quot;LedBar.h&quot;</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="preprocessor">#include &quot;Led.h&quot;</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span> </div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="preprocessor">#include &quot;qassert.h&quot;</span> <span class="comment">/* for embedded systems-friendly assertions */</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span> </div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span>Q_DEFINE_THIS_MODULE(<span class="stringliteral">&quot;LedBar&quot;</span>)</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span> </div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment">/*</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment"> Example sequence diagram for the LedBar_setPercent() implementation:</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="comment"></span> </div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment"> +----------+       +-----+</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment"> |  LedBar  |       | LED |</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="comment"> +----------+       +-----+</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="comment">       |               |</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="comment">      +-+ Led_on(0)    |</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="comment">      | |-------------&gt;|</span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="comment">      | |              |</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="comment">      | | Led_on(1)    |</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="comment">      | |-------------&gt;|</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="comment">      | |              |</span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span><span class="comment">      | | Led_on(2)    |</span></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="comment">      | |-------------&gt;|</span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span><span class="comment">      | |              |</span></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span><span class="comment">      | | Led_off(3)   |</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span><span class="comment">      | |-------------&gt;|</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span><span class="comment">      | |              |</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span><span class="comment">      | | Led_off(4)   |</span></div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span><span class="comment">      | |-------------&gt;|</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span><span class="comment">      | |              |</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span><span class="comment">      +-+              |</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span><span class="comment">       |               |</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span><span class="comment">*/</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>uint32_t LedBar_setPercent(uint8_t const percent) {</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>    uint8_t <span class="keyword">const</span> n_on = (uint8_t)((percent * MAX_LED) / 100U);</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span><span class="comment"></span> </div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span><span class="comment">    /*! @pre percent must not exceed 100 */</span></div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>    Q_REQUIRE_ID(100, n_on &lt;= MAX_LED);</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span> </div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>    uint32_t p = 0U; <span class="comment">/* power draw in [uW] */</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>    uint8_t i;</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>    <span class="keywordflow">for</span> (i = 0U; i &lt; n_on; ++i) {</div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>        p += Led_on(i);</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>    }</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>    <span class="keywordflow">for</span> (i = n_on; i &lt; MAX_LED; ++i) {</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>        Led_off(i);</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>    }</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>    <span class="keywordflow">return</span> p;</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>}</div>
</div><!-- fragment --> <div class="caption"><center><b>file LedBar.c</b></center></div><p>The low-level interface to the LEDs is defined below (<span class="img file_h"><code>Led.h</code></span>). The individual LEDs are selected by an <code>index</code> parameter. Each individual LED can be turned on by means of the <code>LED_on()</code> function. The <code>LED_on()</code> function returns a value, which corresponds to power consumption of this LED while on. The LED can be turned off by the <code>LED_off()</code> function, which returns <code>void</code>.</p>
<div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="preprocessor">#ifndef LED_H</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="preprocessor">#define LED_H</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span> </div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="keyword">enum</span> { MAX_LED = 5 };</div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span> </div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="comment">/* turns a given LED on and retruns the power drawn by it in uW */</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span>uint32_t Led_on(uint8_t index);</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span> </div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment">/* turns a given LED off */</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="keywordtype">void</span> Led_off(uint8_t index);</div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span> </div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="preprocessor">#endif </span><span class="comment">/* LED_H */</span><span class="preprocessor"></span></div>
</div><!-- fragment --> <div class="caption"><center><b>file Led.h</b></center></div><p>The diagram below shows the relationships between the CUT and the test code: Unity case on the left and QUTest case on the right. In both cases, the <code>LedBar</code> CUT interacts with the hardware through the <code>Led.h</code> interface. The explanation section below the diagram clarifies the interesting elements of the diagram.</p>
<div class="image">
<img src="qutest_mock.gif" alt=""/>
<div class="caption">
Components of the Unity Mock test: Unity left and QUTest right</div></div>
    <p><b>Center: Code Under Test</b></p>
<dl class="tag">
<dt>1</dt>
<dd>The <code>LedBar.c</code> file contains the <a class="el" href="qutest_mock.html#qutest_mock-cut">Code Under Test (CUT)</a>.  </dd>
<dt>2</dt>
<dd>The CUT interacts with the hardware through the <code>Led.h</code> interface. This interface abstracts the LEDs and is all that the CUT needs to "know" about the hardware.  </dd>
</dl>
<div style="clear:both;"></div><p><a class="anchor" id="qutest_mock-unity"></a><b>Left: Unity testing framework (traditional approach)</b> </p><dl class="tag">
<dt>3</dt>
<dd><p class="startdd">The <code>TestLedBar.c</code> file implements the Unity test fixture, which calls the CUT and verifies that it performs as expected.</p>
<blockquote class="doxtable">
<p>&zwj;<b>NOTE:</b> A Unity test fixture for a mock requires a special "test runner", which initializes and cleans up after the mock. This "test runner" must typically be generated automatically, as it is too complex to code manually.  </p>
</blockquote>
</dd>
<dt>4</dt>
<dd></dd>
</dl>
<p>The Unity test fixture uses the <code>MockLed.c</code> implementation of the <code>Led.h</code> interface. The mock object implemented in <code>MockLed.c</code> needs to be "programmed" for each expected scenario <b>before</b> calling the CUT. Thus the structure of conventional tests with a mock is "backwards", meaning that you first specify the expectations and the test ends with a call to the CUT.</p>
<blockquote class="doxtable">
<p>&zwj;<b>NOTE:</b> This mock-object must typically be generated automatically, as it is too complex to code manually. Here, the mock- object was generated by means of the <a href="http://www.throwtheswitch.org/cmock/" target="_blank" class="extern"><b>CMock tool</b></a>, which is included with Unity, but requires installation of the <a href="https://www.ruby-lang.org" class="extern" target="_blank">ruby programming language</a>.  </p>
</blockquote>
<div style="clear:both;"></div><p><b>Right: QUTest testing framework (simplified approach)</b> </p><dl class="tag">
<dt>5</dt>
<dd>The <code>test_LedBar.c</code> file implements the <a class="el" href="qutest_mock.html#qutest_mock-fixture">QUTest test fixture</a>, which calls the CUT, but it does <b>NOT</b> check whether it performs as expected.  </dd>
<dt>6</dt>
<dd>The QUTest test fixture uses the <code>spy_Led.c</code> implementation of the <code>Led.h</code> interface. This spy test double is much simpler than the mock-object used by Unity, so it can easily be <a class="el" href="qutest_mock.html#qutest_mock-spy">coded manually</a>.  </dd>
<dt>7</dt>
<dd>The QUTest test is driven by the <code>test_LedBar.py</code> <a class="el" href="qutest_mock.html#qutest_mock-script">test script</a>. This test script sends commands to the <code>test_LedBar.c</code> fixture and verifies the generated output against the expectations of the test.  </dd>
</dl>
<div style="clear:both;"></div><h1><a class="anchor" id="qutest_mock-run0"></a>
Running the Test with Unity</h1>
<p>The complete code for the mock Unity example is provided in the QP/C framework directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_ledbar\test_unity</code></span>. To run the mock Unity test (on Windows), open a command-prompt and type: </p><pre class="fragment">cd C:\qp\qpc\examples\qutest\unity_ledbar\test_unity
make
</pre><dl class="section note"><dt>Note</dt><dd>The provided <code>Makefile</code> will also work on Linux and macOS. The only difference from Windows is that you open a terminal window and change the directory to <span class="img folder"><code>~/qp/qpc/examples/qutest/unity_ledbar/test</code></span>.</dd></dl>
<p>This will build the <a class="el" href="qutest_mock.html#qutest_mock-fixture">test fixture</a> as a host executable and then it will run it. The screen shot below shows the output produced from the make command.</p>
<div class="image">
<img src="unity_ledbar_unity.jpg" alt=""/>
<div class="caption">
Unity mock test build and run with Unity</div></div>
    <h1><a class="anchor" id="qutest_mock-run"></a>
Running the Test with QUTest</h1>
<p>The complete code for the mock Unity example is provided in the QP/C framework, directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_ledbar\test</code></span>. To run the mock test (on Windows), open a command prompt and type:</p>
<pre class="fragment">qspy
</pre><p>This will start the <a class="el" href="qspy.html">QSPY host utility</a> with the TCP/IP connection to the Target.</p>
<p>Next, open a <b>second</b> command prompt window and type:</p>
<pre class="fragment">cd C:\qp\qpc\examples\qutest\unity_ledbar\test
make
</pre><dl class="section note"><dt>Note</dt><dd>The provided <code>Makefile</code> will also work on Linux and macOS. The only difference from Windows is that you open a terminal window and change the directory to <span class="img folder"><code>~/qp/qpc/examples/qutest/unity_ledbar/qutest</code></span>.</dd></dl>
<p>This will build the <a class="el" href="qutest_mock.html#qutest_mock-fixture">test fixture</a> as a host executable and then it will run the <a class="el" href="qutest_mock.html#qutest_mock-script">test script</a> (in Python). The screen shot below shows the output produced in these two command-prompt windows.</p>
<div class="image">
<img src="unity_ledbar_qutest.jpg" alt=""/>
<div class="caption">
Unity mock test build and run with QUTest (right) and QSPY output (left)</div></div>
    <h1><a class="anchor" id="qutest_mock-spy"></a>
Spy Object (Mock Replacement)</h1>
<p>The following listing shows the "spy-object" (file <span class="img file_c"><code>spy_led.c</code></span>) test-double for the low-level LED module. The explanation section following the listing clarifies the interesting lines of code (lines starting with [xx] labels).</p>
<div class="fragment"><div class="line"> [1] #include <span class="stringliteral">&quot;qpc.h&quot;</span>  <span class="comment">/* QUTest interface */</span></div>
<div class="line"> [2] #include <span class="stringliteral">&quot;Led.h&quot;</span>  <span class="comment">/* original interface */</span></div>
<div class="line"> </div>
<div class="line">     <span class="comment">//Q_DEFINE_THIS_FILE</span></div>
<div class="line"> </div>
<div class="line">     <span class="keyword">enum</span> {</div>
<div class="line"> [3]     LED_MOD = <a class="code hl_enumvalue" href="qpc__qs_8h.html#a30eec3d04b2f928584251b759bf1a0cd">QS_USER1</a> <span class="comment">/* QS app-specific record for the LED module */</span></div>
<div class="line">     };</div>
<div class="line"> </div>
<div class="line"> [4] <span class="keyword">static</span> uint32_t led_power[MAX_LED] = {</div>
<div class="line">         10, 20, 10, 20, 10</div>
<div class="line">     };</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line"> [5] <span class="keywordtype">void</span> Led_DICTIONARY(<span class="keywordtype">void</span>) {</div>
<div class="line">         <a class="code hl_define" href="qpc__qs_8h.html#a3b1ab21c174f2bec448edec8865a8529">QS_FUN_DICTIONARY</a>(&amp;Led_on);</div>
<div class="line">         <a class="code hl_define" href="qpc__qs_8h.html#a3b1ab21c174f2bec448edec8865a8529">QS_FUN_DICTIONARY</a>(&amp;Led_off);</div>
<div class="line">         <a class="code hl_define" href="qpc__qs_8h.html#ae75893daa66c6d0b5a6dfb8f3fca1196">QS_USR_DICTIONARY</a>(LED_MOD);</div>
<div class="line">         <a class="code hl_define" href="qpc__qs_8h.html#a034206ff7f20a4e6426a5f554434643b">QS_OBJ_DICTIONARY</a>(&amp;led_power);</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line">     <span class="comment">/* turns a given LED off */</span></div>
<div class="line"> [6] <span class="keywordtype">void</span> Led_off(uint8_t index) {</div>
<div class="line">         QS_BEGIN(LED_MOD, (<span class="keywordtype">void</span> *)0) <span class="comment">/* user-specific record */</span></div>
<div class="line">             <a class="code hl_define" href="qpc__qs_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN</a>(&amp;Led_off); <span class="comment">/* function called */</span></div>
<div class="line">             <a class="code hl_define" href="qpc__qs_8h.html#a129128a3bb20d0b9286ff7c68f1401ab">QS_U8</a> (0, index); <span class="comment">/* parameter */</span></div>
<div class="line">         <a class="code hl_define" href="qpc__qs_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END</a>()</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/* turns a given LED on and returns the power drawn by it in uW */</span></div>
<div class="line"> [7] uint32_t Led_on(uint8_t index) {</div>
<div class="line"> [8]     uint32_t ret = led_power[index]; <span class="comment">/* assume default power */</span></div>
<div class="line"> [9]     <a class="code hl_define" href="qpc__qs_8h.html#a9f048034d6f9267e8333dbcd7bb67349">QS_TEST_PROBE_DEF</a>(&amp;Led_on)</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* tweak the returned power draw from the test probe */</span></div>
<div class="line">[10]     <a class="code hl_define" href="qpc__qs_8h.html#ad4d6a7778df089bb64202ba9ec8a4ddb">QS_TEST_PROBE</a>(</div>
<div class="line">[11]         ret = (uint32_t)qs_tp_;</div>
<div class="line">         )</div>
<div class="line"> </div>
<div class="line">[12]     QS_BEGIN(LED_MOD, (<span class="keywordtype">void</span> *)0) <span class="comment">/* user-specific record */</span></div>
<div class="line">             <a class="code hl_define" href="qpc__qs_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN</a>(&amp;Led_on);  <span class="comment">/* function called */</span></div>
<div class="line">             <a class="code hl_define" href="qpc__qs_8h.html#a17e249417c7e49c8e2913b17696acbc0">QS_U32</a>(0, ret);   <span class="comment">/* value returned */</span></div>
<div class="line">             <a class="code hl_define" href="qpc__qs_8h.html#a129128a3bb20d0b9286ff7c68f1401ab">QS_U8</a> (0, index); <span class="comment">/* parameter */</span></div>
<div class="line">         <a class="code hl_define" href="qpc__qs_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END</a>()</div>
<div class="line"> </div>
<div class="line">[13]     <span class="keywordflow">return</span> ret;</div>
<div class="line">     }</div>
<div class="ttc" id="aqpc__qs_8h_html_a034206ff7f20a4e6426a5f554434643b"><div class="ttname"><a href="qpc__qs_8h.html#a034206ff7f20a4e6426a5f554434643b">QS_OBJ_DICTIONARY</a></div><div class="ttdeci">#define QS_OBJ_DICTIONARY(obj_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01331">qpc_qs.h:1331</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a129128a3bb20d0b9286ff7c68f1401ab"><div class="ttname"><a href="qpc__qs_8h.html#a129128a3bb20d0b9286ff7c68f1401ab">QS_U8</a></div><div class="ttdeci">#define QS_U8(width_, data_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01141">qpc_qs.h:1141</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a17e249417c7e49c8e2913b17696acbc0"><div class="ttname"><a href="qpc__qs_8h.html#a17e249417c7e49c8e2913b17696acbc0">QS_U32</a></div><div class="ttdeci">#define QS_U32(width_, data_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01161">qpc_qs.h:1161</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a2ed1002d3dda6d95f9f64c59b8453c71"><div class="ttname"><a href="qpc__qs_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END</a></div><div class="ttdeci">#define QS_END()</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01082">qpc_qs.h:1082</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a30eec3d04b2f928584251b759bf1a0cd"><div class="ttname"><a href="qpc__qs_8h.html#a30eec3d04b2f928584251b759bf1a0cd">QS_USER1</a></div><div class="ttdeci">@ QS_USER1</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l00308">qpc_qs.h:308</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a3b1ab21c174f2bec448edec8865a8529"><div class="ttname"><a href="qpc__qs_8h.html#a3b1ab21c174f2bec448edec8865a8529">QS_FUN_DICTIONARY</a></div><div class="ttdeci">#define QS_FUN_DICTIONARY(fun_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01366">qpc_qs.h:1366</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a9342913835bccef5ded5a59d2712101a"><div class="ttname"><a href="qpc__qs_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN</a></div><div class="ttdeci">#define QS_FUN(fun_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01240">qpc_qs.h:1240</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a9f048034d6f9267e8333dbcd7bb67349"><div class="ttname"><a href="qpc__qs_8h.html#a9f048034d6f9267e8333dbcd7bb67349">QS_TEST_PROBE_DEF</a></div><div class="ttdeci">#define QS_TEST_PROBE_DEF(fun_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01680">qpc_qs.h:1680</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_ad4d6a7778df089bb64202ba9ec8a4ddb"><div class="ttname"><a href="qpc__qs_8h.html#ad4d6a7778df089bb64202ba9ec8a4ddb">QS_TEST_PROBE</a></div><div class="ttdeci">#define QS_TEST_PROBE(code_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01684">qpc_qs.h:1684</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_ae75893daa66c6d0b5a6dfb8f3fca1196"><div class="ttname"><a href="qpc__qs_8h.html#ae75893daa66c6d0b5a6dfb8f3fca1196">QS_USR_DICTIONARY</a></div><div class="ttdeci">#define QS_USR_DICTIONARY(rec_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01376">qpc_qs.h:1376</a></div></div>
</div><!-- fragment --><dl class="tag">
<dt>1</dt>
<dd>The <code>"qpc.h"</code> header file includes the QP/C framework, which contains the QUTest interface. Typically, you need to include this header file in QUTest test doubles.  </dd>
<dt>2</dt>
<dd><p class="startdd">The <code>"Led.h"</code> header file specifies the interface to the code being impersonated by this "spy-object". The whole purpose of the spy-object is to implement this interface such that the CUT can call use it as its collaborator.</p>
<blockquote class="doxtable">
<p>&zwj;<b>NOTE:</b> The CUT does not "know" that it is collaborating with a <em>test double</em> (the spy-object in this case). </p>
</blockquote>
</dd>
<dt>3</dt>
<dd>This enumeration lists the <a class="el" href="qs.html#qs_app">application-specific QS trace records</a> that will be produced by the fake LED operations. The enumeration starts with <a class="el" href="qpc__qs_8h.html#a30eec3d04b2f928584251b759bf1a0cd">QS_USER1</a> offset, which is the second group of user-specific records. The first group (<a class="el" href="qpc__qs_8h.html#a0fddefe03be6a92615c328ac4f456942">QS_USER0</a> offset) is used by the main <a class="el" href="qutest_mock.html#qutest_mock-fixture">test fixture</a>.  </dd>
<dt>4</dt>
<dd>The <code>led_power[]</code> array contains the default power ratings for the individual LEDs in the LED-bar. These values will be returned from the fake <code>Led_on()</code> implementation (if not overridden by the "Test Probe").  </dd>
<dt>5</dt>
<dd>The <code>Led_DICTIONARY()</code> function produces the dictionaries for the spy-object. This function is not part of the real LED interface (see <code>Led.h</code> in the <code>src</code> directory), but is needed only for testing.  </dd>
<dt>6</dt>
<dd>This is a fake <code>Led_off()</code> implementation, which generates an <a class="el" href="qs.html#qs_app">application-specific QS trace record</a> to report the call and the parameter to QSPY.  </dd>
<dt>7</dt>
<dd>This is a fake <code>Led_on()</code> implementation.  </dd>
<dt>8</dt>
<dd>The <code>ret</code> variable will be the power rating for this LED returned from this function. The variable is initialized from the <code>led_power[]</code> array, which contains the default power rating for the LEDs.  </dd>
<dt>9</dt>
<dd>The macro <code><a class="el" href="qpc__qs_8h.html#a9f048034d6f9267e8333dbcd7bb67349">QS_TEST_PROBE_DEF()</a></code> defines a <a class="el" href="qutest_fixture.html#qutest_fixture-probe">Test Probe</a> for this function (notice the <code>&amp;Led_on</code> function-pointer parameter). This Test Probe retrieves a value set for this function from the test-script. (If no value has been set, the <code><a class="el" href="qpc__qs_8h.html#a9f048034d6f9267e8333dbcd7bb67349">QS_TEST_PROBE_DEF()</a></code> retrieves value 0).  </dd>
<dt>10</dt>
<dd>The <code><a class="el" href="qpc__qs_8h.html#ad4d6a7778df089bb64202ba9ec8a4ddb">QS_TEST_PROBE()</a></code> macro executes the enclosed snipped of code only if the Test Probe (defined at label [9]) is not zero.  </dd>
<dt>11</dt>
<dd>If the Test Probe is not zero (it has been set from the test script), the <code>ret</code> value is updated from the value of the Test Probe <code>qs_tp_</code>.  </dd>
</dl>
<blockquote class="doxtable">
<p>&zwj;<b>NOTE:</b> This demonstrates how to program a <b>return value</b> in a spy-object. This corresponds directly to the same capability of traditional mock-objects. </p>
</blockquote>
<blockquote class="doxtable">
<p>&zwj;<b>NOTE:</b> Test Probe is just one way in which a pre-programmed value can be returned from a fake function. This option is illustrated in <a class="el" href="qutest_mock.html#qutest_mock-script25">test script [25]</a>. Another way in QUTest is to use the poke() test command to alter the values in the <code>led_power[]</code> array. This option is illustrated in <a class="el" href="qutest_mock.html#qutest_mock-script21">test script [21]</a>. </p>
</blockquote>
<dl class="tag">
<dt>12</dt>
<dd>An <a class="el" href="qs.html#qs_app">application-specific QS trace record</a> is generated to report the call, the parameter, and the return value to QSPY.  </dd>
<dt>13</dt>
<dd>The <code>ret</code> value is returned to the caller (CUT).  </dd>
</dl>
<div style="clear:both;"></div><h1><a class="anchor" id="qutest_mock-fixture"></a>
Test Fixture</h1>
<p>The following listing shows the test fixture for the LedBar tests (file <span class="img file_c"><code>test_ledbar.c</code></span>). The explanation section following the listing clarifies the interesting lines of code (lines starting with [xx] labels).</p>
<div class="fragment"><div class="line"> [1] #include <span class="stringliteral">&quot;qpc.h&quot;</span>  <span class="comment">/* QUTest interface */</span></div>
<div class="line"> [2] #include <span class="stringliteral">&quot;LedBar.h&quot;</span> <span class="comment">/* CUT interface */</span></div>
<div class="line"> </div>
<div class="line">     Q_DEFINE_THIS_FILE</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line"> [3] <span class="keywordtype">void</span> Led_DICTIONARY(<span class="keywordtype">void</span>); <span class="comment">/* dictionaries for the Led &quot;spy &quot; test double */</span></div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line">     <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {</div>
<div class="line"> </div>
<div class="line"> [4]     QF_init();  <span class="comment">/* initialize the framework */</span></div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* initialize the QS software tracing */</span></div>
<div class="line"> [5]     Q_ALLEGE(<a class="code hl_define" href="qpc__qs_8h.html#af22371611fe57862a37eb785debb7921">QS_INIT</a>(argc &gt; 1 ? argv[1] : (<span class="keywordtype">void</span> *)0));</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* dictionaries... */</span></div>
<div class="line"> [6]     Led_DICTIONARY();</div>
<div class="line"> [7]     <a class="code hl_define" href="qpc__qs_8h.html#a3b1ab21c174f2bec448edec8865a8529">QS_FUN_DICTIONARY</a>(&amp;LedBar_setPercent);</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* filter setup... */</span></div>
<div class="line"> [8]     QS_FILTER_ON(<a class="code hl_enumvalue" href="qpc__qs_8h.html#ae7b17c3ad4c237e9e89693fea1690513">QS_ALL_RECORDS</a>);</div>
<div class="line"> </div>
<div class="line"> [9]     <span class="keywordflow">return</span> QF_run(); <span class="comment">/* run the tests */</span></div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line">     <span class="keywordtype">void</span> <a class="code hl_function" href="qpc__qs_8h.html#a3d316077c13f8033c1a391590937e696">QS_onTestSetup</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">     }</div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">     <span class="keywordtype">void</span> <a class="code hl_function" href="qpc__qs_8h.html#abefe60a3ba6b11d5406bba4708a48f2d">QS_onTestTeardown</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">     <span class="keywordtype">void</span> QS_onCommand(uint8_t cmdId,</div>
<div class="line">                       uint32_t param1, uint32_t param2, uint32_t param3)</div>
<div class="line">     {</div>
<div class="line">         <span class="keywordflow">switch</span> (cmdId) {</div>
<div class="line">[10]         <span class="keywordflow">case</span> 0: { <span class="comment">/* call the CUT: LedBar_setPercent */</span></div>
<div class="line">[11]             uint32_t ret = LedBar_setPercent((uint8_t)param1);</div>
<div class="line">[12]             QS_BEGIN(<a class="code hl_enumvalue" href="qpc__qs_8h.html#a48cec974671d01f280b2b1a33225d176">QS_USER</a> + cmdId, (<span class="keywordtype">void</span> *)0) <span class="comment">/* user-specific record */</span></div>
<div class="line">[13]                 <a class="code hl_define" href="qpc__qs_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN</a>(&amp;LedBar_setPercent); <span class="comment">/* function called */</span></div>
<div class="line">[14]                 <a class="code hl_define" href="qpc__qs_8h.html#a17e249417c7e49c8e2913b17696acbc0">QS_U32</a>(0, ret); <span class="comment">/* value returned */</span></div>
<div class="line">[15]                 <a class="code hl_define" href="qpc__qs_8h.html#a129128a3bb20d0b9286ff7c68f1401ab">QS_U8</a> (0, (uint8_t)param1); <span class="comment">/* parameter */</span></div>
<div class="line">                 <a class="code hl_define" href="qpc__qs_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END</a>()</div>
<div class="line">                 break;</div>
<div class="line">             }</div>
<div class="line">             default:</div>
<div class="line">                 break;</div>
<div class="line">         }</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* unused parameters... */</span></div>
<div class="line">         <span class="comment">//(void)param1;</span></div>
<div class="line">         (<span class="keywordtype">void</span>)param2;</div>
<div class="line">         (<span class="keywordtype">void</span>)param3;</div>
<div class="line">     }</div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">     <span class="comment">/* host callback function to &quot;massage&quot; the event, if necessary */</span></div>
<div class="line">     <span class="keywordtype">void</span> <a class="code hl_function" href="qpc__qs_8h.html#ad3f890b82210f9d63348d9764bdc1073">QS_onTestEvt</a>(QEvt *e) {</div>
<div class="line">         (void)e;</div>
<div class="line"><span class="preprocessor">     #ifdef Q_HOST  </span><span class="comment">/* is this test compiled for a desktop Host computer? */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">     #else </span><span class="comment">/* this test is compiled for an embedded Target system */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">     #endif</span></div>
<div class="line">     }</div>
<div class="line">     <span class="comment">/*..........................................................................*/</span><span class="comment"></span></div>
<div class="line"><span class="comment">     /*! callback function to output the posted QP events (not used here) */</span></div>
<div class="line">     <span class="keywordtype">void</span> <a class="code hl_function" href="qpc__qs_8h.html#a14579f8a23d950a5f2393fa3f9b0e145">QS_onTestPost</a>(<span class="keywordtype">void</span> <span class="keyword">const</span> *sender, QActive *recipient,</div>
<div class="line">                        QEvt <span class="keyword">const</span> *e, <span class="keywordtype">bool</span> status)</div>
<div class="line">     {</div>
<div class="line">         (void)sender;</div>
<div class="line">         (void)recipient;</div>
<div class="line">         (void)e;</div>
<div class="line">         (void)status;</div>
<div class="line">     }</div>
<div class="ttc" id="aqpc__qs_8h_html_a14579f8a23d950a5f2393fa3f9b0e145"><div class="ttname"><a href="qpc__qs_8h.html#a14579f8a23d950a5f2393fa3f9b0e145">QS_onTestPost</a></div><div class="ttdeci">void QS_onTestPost(void const *sender, QActive *recipient, QEvt const *e, bool status)</div></div>
<div class="ttc" id="aqpc__qs_8h_html_a3d316077c13f8033c1a391590937e696"><div class="ttname"><a href="qpc__qs_8h.html#a3d316077c13f8033c1a391590937e696">QS_onTestSetup</a></div><div class="ttdeci">void QS_onTestSetup(void)</div></div>
<div class="ttc" id="aqpc__qs_8h_html_a48cec974671d01f280b2b1a33225d176"><div class="ttname"><a href="qpc__qs_8h.html#a48cec974671d01f280b2b1a33225d176">QS_USER</a></div><div class="ttdeci">@ QS_USER</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l00306">qpc_qs.h:306</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_abefe60a3ba6b11d5406bba4708a48f2d"><div class="ttname"><a href="qpc__qs_8h.html#abefe60a3ba6b11d5406bba4708a48f2d">QS_onTestTeardown</a></div><div class="ttdeci">void QS_onTestTeardown(void)</div></div>
<div class="ttc" id="aqpc__qs_8h_html_ad3f890b82210f9d63348d9764bdc1073"><div class="ttname"><a href="qpc__qs_8h.html#ad3f890b82210f9d63348d9764bdc1073">QS_onTestEvt</a></div><div class="ttdeci">void QS_onTestEvt(QEvt *e)</div></div>
<div class="ttc" id="aqpc__qs_8h_html_ae7b17c3ad4c237e9e89693fea1690513"><div class="ttname"><a href="qpc__qs_8h.html#ae7b17c3ad4c237e9e89693fea1690513">QS_ALL_RECORDS</a></div><div class="ttdeci">@ QS_ALL_RECORDS</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l00283">qpc_qs.h:283</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_af22371611fe57862a37eb785debb7921"><div class="ttname"><a href="qpc__qs_8h.html#af22371611fe57862a37eb785debb7921">QS_INIT</a></div><div class="ttdeci">#define QS_INIT(arg_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l00995">qpc_qs.h:995</a></div></div>
</div><!-- fragment --><dl class="tag">
<dt>1</dt>
<dd>The <code>"qpc.h"</code> header file includes the <a href="https://www.state-machine.com/qpc/">QP/C framework</a>, which contains the QUTest interface. Typically, you need to include this header file in QUTest test doubles. <blockquote class="doxtable">
<p>&zwj;<b>NOTE:</b> for test fixtures based on the <a href="https://www.state-machine.com/qpcpp/">QP/C++ framework</a>, you need to include the <code>"qpcpp.h"</code> header file.  </p>
</blockquote>
</dd>
<dt>2</dt>
<dd>The <code>"LedBar.h"</code> header file specifies the interface to the CUT.  </dd>
<dt>3</dt>
<dd>The <code>Led_DICTIONARY()</code> function prototype is declared directly in the test fixture. This is the only extension from the <code>"Led.h"</code> interface implemented in the <a class="el" href="qutest_mock.html#qutest_mock-spy">spy-object</a>.  </dd>
<dt>4</dt>
<dd>As usual the <code>main()</code> function of the test fixture initialzies the QF framework.  </dd>
<dt>5</dt>
<dd>As usual the <code>main()</code> function of the test fixture initalizes the QS software tracing.  </dd>
<dt>6</dt>
<dd>The call to the <code>Led_DICTIONARY()</code> function outputs the <a class="el" href="qs.html#qs_dict">QS dictionaries</a> for the <a class="el" href="qutest_mock.html#qutest_mock-spy">spy-object</a>.  </dd>
<dt>7</dt>
<dd>The <a class="el" href="qs.html#qs_dict">QS dictionary</a> for the <code>LedBar_setPercentn()</code> CUT is produced as well.  </dd>
<dt>8</dt>
<dd>The <a class="el" href="qs.html#qs_global">QS global filter</a> is set up to output all QS records.  </dd>
<dt>9</dt>
<dd>The <code>QF_run()</code> function enters the event loop to wait for commands from the <a class="el" href="qutest_mock.html#qutest_mock-script">test script</a>.  </dd>
</dl>
<div style="clear:both;"></div><h1><a class="anchor" id="qutest_mock-script"></a>
Test Script</h1>
<p>The following listing shows the <em>test script</em> for the LedBar tests (file <span class="img file_py"><code>test_LedBar.py</code></span>). The explanation section following the listing clarifies the interesting lines of code (lines starting with <code>[xx]</code> labels).</p>
<dl class="section note"><dt>Note</dt><dd>The following test script performs the same tests as the <code>TestLedBar.c</code> Unity test fixture. Compared to the mock-object approach, however, the QUTest test script has the more intuitive structure, in which a command triggering CUT is <b>followed</b> by the expecations. In contrast, the traditional <a class="el" href="qutest_mock.html#qutest_mock-unity">Unity tests with mock-object</a> were structured "backwards" (the expectations <b>preceded</b> the call to CUT).</dd></dl>
<div class="fragment"><div class="line"> [1] <span class="comment"># preamble...</span></div>
<div class="line"> </div>
<div class="line">     <span class="comment"># tests...</span></div>
<div class="line"> [2] test(<span class="stringliteral">&quot;LedBar 0% all off&quot;</span>)</div>
<div class="line"> [3] command(0, 0)</div>
<div class="line"> [4] expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 0&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 1&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 2&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 3&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 4&quot;</span>)</div>
<div class="line"> [5] expect(<span class="stringliteral">&quot;@timestamp USER+000 LedBar_setPercent 0 0&quot;</span>)</div>
<div class="line"> [6] expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line"> [7] test(<span class="stringliteral">&quot;LedBar 100% all on&quot;</span>, NORESET)</div>
<div class="line"> [8] command(0, 100)</div>
<div class="line"> [9] expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 10 0&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 20 1&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 10 2&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 20 3&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 10 4&quot;</span>)</div>
<div class="line">[10] expect(<span class="stringliteral">&quot;@timestamp USER+000 LedBar_setPercent 70 100&quot;</span>)</div>
<div class="line">[11] expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line">[12] test(<span class="stringliteral">&quot;LedBar 19% all off&quot;</span>, NORESET)</div>
<div class="line">[13] command(0, 19)</div>
<div class="line">[14] expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 0&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 1&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 2&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 3&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 4&quot;</span>)</div>
<div class="line">[15] expect(<span class="stringliteral">&quot;@timestamp USER+000 LedBar_setPercent 0 19&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line">[16] test(<span class="stringliteral">&quot;LedBar 20% one on&quot;</span>, NORESET)</div>
<div class="line">[17] command(0, 20)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 10 0&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 1&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 2&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 3&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 4&quot;</span>)</div>
<div class="line">[18] expect(<span class="stringliteral">&quot;@timestamp USER+000 LedBar_setPercent 10 20&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line">[19] test(<span class="stringliteral">&quot;LedBar 50% two on&quot;</span>, NORESET)</div>
<div class="line">[20] current_obj(OBJ_AP, <span class="stringliteral">&quot;led_power&quot;</span>)</div>
<div class="line">[21] poke(0, 4, pack(<span class="stringliteral">&quot;&lt;LL&quot;</span>, 25, 15))</div>
<div class="line">[22] command(0, 50)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 25 0&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 15 1&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 2&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 3&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 4&quot;</span>)</div>
<div class="line">[23] expect(<span class="stringliteral">&quot;@timestamp USER+000 LedBar_setPercent 40 50&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line">[24] test(<span class="stringliteral">&quot;LedBar 99% four on&quot;</span>, NORESET)</div>
<div class="line">[25] probe(<span class="stringliteral">&quot;Led_on&quot;</span>, 17)</div>
<div class="line">[26] probe(<span class="stringliteral">&quot;Led_on&quot;</span>, 13)</div>
<div class="line">[27] command(0, 99)</div>
<div class="line">[28] expect(<span class="stringliteral">&quot;@timestamp TstProbe Fun=Led_on,Data=17&quot;</span>)</div>
<div class="line">[29] expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 17 0&quot;</span>)</div>
<div class="line">[30] expect(<span class="stringliteral">&quot;@timestamp TstProbe Fun=Led_on,Data=13&quot;</span>)</div>
<div class="line">[31] expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 13 1&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 10 2&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_on 20 3&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp LED_MOD Led_off 4&quot;</span>)</div>
<div class="line">[32] expect(<span class="stringliteral">&quot;@timestamp USER+000 LedBar_setPercent 60 99&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
</div><!-- fragment --><dl class="tag">
<dt>1</dt>
<dd>The preamble is empty, because no special actions are needed on reset/setup/teardown.  </dd>
</dl>
<div style="clear:both;"></div><p><b>Test: "LedBar 0% all off"</b> checks that all LEDs are turned off to display 0% </p><dl class="tag">
<dt>2</dt>
<dd>The test() command starts the test.  </dd>
<dt>3</dt>
<dd>The command(0, 0) calls the <code>LedBar_setPercent()</code> CUT with the 0 percent argument.  </dd>
<dt>4</dt>
<dd>This expect() command verifies the output produced by calling the <code>LED_off()</code> function from the spy-object.  </dd>
<dt>5</dt>
<dd>This expect() command verifies the output produced by calling the <code>LedBar_setPercent()</code> function from the CUT. Note that the returned total power consumption is zero.  </dd>
<dt>6</dt>
<dd>This expect() command verifies that all output from the original command(0, 0) has been produced.  </dd>
</dl>
<div style="clear:both;"></div><p><b>Test: "LedBar 100% all on"</b> checks that all LEDs are turned on to display 100% </p><dl class="tag">
<dt>8</dt>
<dd>The test() command starts the test.  </dd>
<dt>9</dt>
<dd>The command(0, 100) calls the <code>LedBar_setPercent()</code> CUT with the 100 percent argument.  </dd>
<dt>10</dt>
<dd>This expect() command verifies the output produced by calling the <code>LedBar_setPercent()</code> function from the CUT. Note that the returned total power consumption is 70.  </dd>
<dt>11</dt>
<dd>This expect() command verifies that all output from the original command(0, 100) has been produced.  </dd>
</dl>
<div style="clear:both;"></div><p><b>Test: "LedBar 19% all off"</b> checks that all LEDs are turned off to display 19% </p><dl class="tag">
<dt>12</dt>
<dd>The test() command starts the test (NOTE: this is a NORESET test).  </dd>
<dt>13</dt>
<dd>The command(0, 19) calls the <code>LedBar_setPercent()</code> CUT with the 19 percent argument.  </dd>
<dt>14</dt>
<dd>This expect() command verifies the output produced by calling the <code>LED_off()</code> function from the spy-object.  </dd>
<dt>15</dt>
<dd>This expect() command verifies the output produced by calling the <code>LedBar_setPercent()</code> function from the CUT. Note that the returned total power consumption is 0.  </dd>
</dl>
<div style="clear:both;"></div><p><b>Test: "LedBar 20% one on"</b> checks that one LED is turned on to display 20% </p><dl class="tag">
<dt>16</dt>
<dd>The test() command starts the test (NOTE: this is a NORESET test).  </dd>
<dt>17</dt>
<dd>The command(0, 20) calls the <code>LedBar_setPercent()</code> CUT with the 20 percent argument.  </dd>
<dt>18</dt>
<dd>This expect() command verifies the output produced by calling the <code>LedBar_setPercent()</code> function from the CUT. Note that the returned total power consumption is 10.  </dd>
</dl>
<div style="clear:both;"></div><p><b>Test: "LedBar 50% two on"</b> checks that two LEDs are turned on to display 50% </p><dl class="tag">
<dt>19</dt>
<dd>The test() command starts the test (NOTE: this is a NORESET test).  </dd>
<dt>20</dt>
<dd>The current_obj(OBJ_AP, led_power")" command sets the "current application object" to "led_power" (see <a class="el" href="qutest_mock.html#qutest_mock-spy">spy-object</a>[4]).  </dd>
<dt>21 <a class="anchor" id="qutest_mock-script21"></a> </dt>
<dd>The poke(0, 4, pack(&lt;LL", 25, 15))" command pokes the given data into the "current application object". Specifically, this poke() command pokes the data starting from offset 0, data-size 4, binary-data <code>pack("&lt;LL", 25, 15)</code>.  </dd>
<dt>22</dt>
<dd>The command(0, 50) calls the <code>LedBar_setPercent()</code> CUT with the 50 percent argument.  </dd>
<dt>23</dt>
<dd>This expect() command verifies the output produced by calling the <code>LedBar_setPercent()</code> function from the CUT. Note that the returned total power consumption is 40, which is due to poking the data into the <code>led_power</code> array.  </dd>
</dl>
<div style="clear:both;"></div><p><b>Test: "LedBar 99% two on"</b> checks that two LEDs are turned on to display 99% </p><dl class="tag">
<dt>24</dt>
<dd>The test() command starts the test (NOTE: this is a NORESET test).  </dd>
<dt>25 <a class="anchor" id="qutest_mock-script25"></a> </dt>
<dd>The probe(Led_on", 17)" command sends the <a class="el" href="qutest_fixture.html#qutest_fixture-probe">test-probe</a> value 17 for function <code>Led_on</code>  </dd>
<dt>26</dt>
<dd>The probe(Led_on", 13)" command sends the <a class="el" href="qutest_fixture.html#qutest_fixture-probe">test-probe</a> another value 13 for function <code>Led_on</code>  </dd>
<dt>27</dt>
<dd>The command(0, 99) calls the <code>LedBar_setPercent()</code> CUT with the 99 percent argument.  </dd>
<dt>28</dt>
<dd>This expect() command verifies the test-probe sent at step [25] has been retrieved.  </dd>
<dt>29</dt>
<dd>This expect() command verifies the function <code>Led_on</code> has been called, and that it returned 17.  </dd>
<dt>30</dt>
<dd>This expect() command verifies the test-probe sent at step [26] has been retrieved.  </dd>
<dt>31</dt>
<dd>This expect() command verifies the function <code>Led_on</code> has been called, and that it returned 13.  </dd>
<dt>32</dt>
<dd>This expect() command verifies the output produced by calling the <code>LedBar_setPercent()</code> function from the CUT. Note that the returned total power consumption is 60, which is due to using test-probes to alter the return values returned from <code>Led_on()</code>.  </dd>
</dl>
<div style="clear:both;"></div><p><br  />
 <span class="prev_button"><a class="el" href="qutest_unity.html">Basic Unity Example</a></span><span class="next_button"><a class="el" href="qutest_qhsm.html">Hierarchical State Machine Example</a></span> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="qutest.html">QUTest&trade; Unit Testing Harness</a></li><li class="navelem"><a class="el" href="qutest_tut.html">QUTest&trade; Tutorial</a></li>
    <li class="footer">
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2023 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QTools 7.2.1</b> &nbsp;|&nbsp; Updated on Thu Jan 26 2023
<hr class="footer"/><address class="footer"><small>
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2023 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QTools 7.2.1</b> &nbsp;|&nbsp; Updated on Thu Jan 26 2023
</small></address>
    </li>
  </ul>
</div>
</body>
</html>
