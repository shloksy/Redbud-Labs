<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QTools: Basic Unity Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="ql-preview.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="ql-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
  <div id="projectlogo">
    <a href="https://www.state-machine.com" title="Quantum Leaps"><img alt="Logo" src="logo_ql.png"/></a>
  </div>
   <div id="projectname">
    QTools
    &nbsp;<span id="projectnumber">7.2.1</span>
   </div>
   <div id="projectbrief">Collection of Host-Based Tools</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('qutest_unity.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Basic Unity Example </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><span class="prev_button"><a class="el" href="qutest_tut.html">QUTest&trade; Tutorial</a></span><span class="next_button"><a class="el" href="qutest_mock.html">Unity Mock Example</a></span></p>
<p>This example is based on the simple <code>example_1</code> that ships with the <a href="http://www.throwtheswitch.org/unity" target="_blank" class="extern"><b>Unity unit testing framework</b></a>. This simplest example of Unity has nothing to do with the QP frameworks. The purpose is to illustrate that QUTest&trade; can be used with generic C code and to compare QUTest&trade; with Unity. </p>
<dl class="section remark"><dt>Remarks</dt><dd>This simple example runs QUTest tests on the host (Windows, Linux, or macOS) for both Unity and QUTest. The QUTest version also runs on embedded boards (NUCLEO-L053R8 from ST, EFM32 Pearl-Gecko board from Silicon Labs and TivaC LaunchPad from Texas Instruments and ). The instructions for building and running the code on the embedded boards are located at the end of this lesson. <br  />
 <img src="platforms.png" alt="" class="inline" title="Targets for this example"/>    </dd></dl>
<h1><a class="anchor" id="qutest_unity-cut"></a>
Code Under Test (CUT)</h1>
<dl class="section note"><dt>Note</dt><dd>Because it uses pure C code, the Basic Unity example is only available in the <a href="https://www.state-machine.com/qpc"><b>QP/C framework</b></a>, and is <b>not</b> available in the <a href="https://www.state-machine.com/qpcpp">QP/C++ framework</a>.</dd></dl>
<p>The CUT in this example is the file <span class="img file_c"><code>my_strlen.c</code></span> located in the directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_strlen\src</code></span>:</p>
<p><a class="anchor" id="qutest_tut_basic-cut"></a></p><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="preprocessor">#include &quot;my_strlen.h&quot;</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span> </div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span>uint16_t my_strlen(<span class="keywordtype">char</span> <span class="keyword">const</span> *str) {</div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span>    uint16_t len = 0U;</div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span>    <span class="keywordflow">for</span> (; *str != <span class="charliteral">&#39;\0&#39;</span>; ++str) {</div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span>        ++len;</div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span>    }</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span>    <span class="keywordflow">return</span> len;</div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span>}</div>
</div><!-- fragment --><h1><a class="anchor" id="qutest_unity-run0"></a>
Running the Test with Unity</h1>
<p>The complete code for the basic Unity example is provided in the QP/C framework directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_strlen\test</code></span>. To run the basic Unity test (on Windows), open a command-prompt and type: </p><pre class="fragment">cd C:\qp\qpc\examples\qutest\unity_strlen\test
make
</pre><dl class="section note"><dt>Note</dt><dd>The provided <code>Makefile</code> will also work on Linux and macOS. The only difference from Windows is that you open a terminal window and change the directory to <span class="img folder"><code>~/qp/qpc/examples/qutest/unity_strlen/test</code></span>.</dd></dl>
<p>This will build the <a class="el" href="qutest_unity.html#qutest_unity-fixture">test fixture</a> as a host executable and then it will run it. The screen shot below shows the output produced from the make command.</p>
<div class="image">
<img src="unity_strlen_unity.jpg" alt=""/>
<div class="caption">
Unity example_1 test build and run with Unity</div></div>
    <h1><a class="anchor" id="qutest_unity-run"></a>
Running the Test with QUTest</h1>
<p>The complete code for the basic Unity example is provided in the QP/C framework directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_strlen\qutest</code></span>. To run the basic test (on Windows), open a command prompt and type:</p>
<pre class="fragment">qspy
</pre><p>This will start the <a class="el" href="qspy.html">QSPY host utility</a> with the TCP/IP connection to the Target.</p>
<p>Next, open a <b>second</b> command prompt window and type:</p>
<pre class="fragment">cd C:\qp\qpc\examples\qutest\unity_strlen\qutest
make
</pre><dl class="section note"><dt>Note</dt><dd>The provided <code>Makefile</code> will also work on Linux and MacOS. The only difference from Windows is that you open a terminal window and change the directory to <span class="img folder"><code>~/qp/qpc/examples/qutest/unity_strlen/qutest</code></span>.</dd></dl>
<p>This will build the <a class="el" href="qutest_unity.html#qutest_unity-fixture">test fixture</a> as a host executable and then it will run the <a class="el" href="qutest_unity.html#qutest_unity-script">test script</a> (in Python). The screen shot below shows the output produced in these two command-prompt windows.</p>
<div class="image">
<img src="unity_strlen_qutest.jpg" alt=""/>
<div class="caption">
Unity example_1 test build and run with QUTest (right) and QSPY output (left)</div></div>
    <h1><a class="anchor" id="qutest_unity-fixture"></a>
Test Fixture</h1>
<p>The job of a <a class="el" href="qutest_fixture.html">test fixture</a> is to exercise the <b>CUT</b> (<span class="img file_c"><code>my_strlen.c</code></span> in this case) and report the results back to the <a class="el" href="qspy.html">QSPY host application</a>. Note that a <em>test fixture</em> in QUTest&trade; is <b>not</b> supposed to perform any checks whether the CUT operates "correctly". Instead, your <em>test fixture</em> should only provide facilities to thoroughly exercise the <b>CUT</b> remotely from the <a class="el" href="qutest_unity.html#qutest_unity-script">test script</a>(s). A properly written test fixture can typically be used for many tests (implemented in multiple test scripts).</p>
<dl class="section remark"><dt>Remarks</dt><dd>Coming up with a "good" <em>test fixture</em> requires some practice, but when you study the examples in this Tutorial, you will see some instances of flexible <em>test fixtures</em> that allow you to to run a wide variety of tests on them.</dd></dl>
<p>The following listing shows the complete QUTest <em>test fixture</em> for the basic tests (file <span class="img file_c"><code>test_strlen.c</code></span> in the directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_strlen\qutest</code></span>). The explanation section following the listing clarifies the interesting lines of code (lines starting with <code>[xx]</code> labels).</p>
<div class="fragment"><div class="line"> [1] #include <span class="stringliteral">&quot;qpc.h&quot;</span>  <span class="comment">/* QUTest interface */</span></div>
<div class="line"> [2] #include <span class="stringliteral">&quot;my_strlen.h&quot;</span> <span class="comment">/* CUT interface */</span></div>
<div class="line"> </div>
<div class="line"> [3] Q_DEFINE_THIS_FILE</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line"> [4]   <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keywordtype">string</span>[128];</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line"> [5] <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {</div>
<div class="line"> </div>
<div class="line"> [6]     QF_init();  <span class="comment">/* initialize the framework */</span></div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* initialize the QS software tracing */</span></div>
<div class="line"> [7]     Q_ALLEGE(<a class="code hl_define" href="qpc__qs_8h.html#af22371611fe57862a37eb785debb7921">QS_INIT</a>(argc &gt; 1 ? argv[1] : (<span class="keywordtype">void</span> *)0));</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* dictionaries... */</span></div>
<div class="line"> [8]     <a class="code hl_define" href="qpc__qs_8h.html#a3b1ab21c174f2bec448edec8865a8529">QS_FUN_DICTIONARY</a>(&amp;my_strlen);</div>
<div class="line"> [9]     <a class="code hl_define" href="qpc__qs_8h.html#a034206ff7f20a4e6426a5f554434643b">QS_OBJ_DICTIONARY</a>(<span class="keywordtype">string</span>);</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* filter setup... */</span></div>
<div class="line">[10]     <a class="code hl_define" href="qpc__qs_8h.html#aa42d8bbc70e6069f9c55d87f76ec15b0">QS_GLB_FILTER</a>(<a class="code hl_enumvalue" href="qpc__qs_8h.html#ae7b17c3ad4c237e9e89693fea1690513">QS_ALL_RECORDS</a>);</div>
<div class="line">[11]     QS_setCurrObj(<a class="code hl_enumvalue" href="qpc__qs_8h.html#ac13b38c805940608cd78cbaa86d62aff">AP_OBJ</a>, <span class="keywordtype">string</span>);</div>
<div class="line"> </div>
<div class="line">[12]     <span class="keywordflow">return</span> QF_run(); <span class="comment">/* run the tests */</span></div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line">[13] <span class="keywordtype">void</span> <a class="code hl_function" href="qpc__qs_8h.html#a3d316077c13f8033c1a391590937e696">QS_onTestSetup</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">     }</div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">[14] <span class="keywordtype">void</span> <a class="code hl_function" href="qpc__qs_8h.html#abefe60a3ba6b11d5406bba4708a48f2d">QS_onTestTeardown</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">[15] <span class="keywordtype">void</span> QS_onCommand(uint8_t cmdId,</div>
<div class="line">                       uint32_t param1, uint32_t param2, uint32_t param3)</div>
<div class="line">     {</div>
<div class="line">         <span class="keywordflow">switch</span> (cmdId) {</div>
<div class="line">             <span class="keywordflow">case</span> 0: { <span class="comment">/* call the CUT: my_strlen(string) */</span></div>
<div class="line">[16]             uint16_t ret = my_strlen(<span class="keywordtype">string</span>);</div>
<div class="line">[17]             <a class="code hl_define" href="qpc__qs_8h.html#a43a3e7f568e445f82c0be2ebf924654c">QS_BEGIN_ID</a>(<a class="code hl_enumvalue" href="qpc__qs_8h.html#a48cec974671d01f280b2b1a33225d176">QS_USER</a> + cmdId, 0U) <span class="comment">/* app-specific record */</span></div>
<div class="line">[18]                 <a class="code hl_define" href="qpc__qs_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN</a>(&amp;my_strlen); <span class="comment">/* function called */</span></div>
<div class="line">[19]                 <a class="code hl_define" href="qpc__qs_8h.html#a3b053b820c90aac6aa7e10adb76a18a5">QS_U16</a>(0, ret); <span class="comment">/* value returned */</span></div>
<div class="line">[20]                 <a class="code hl_define" href="qpc__qs_8h.html#a7ad67719163eea844e44bee7f0478c0a">QS_STR</a>(<span class="keywordtype">string</span>); <span class="comment">/* the current string */</span></div>
<div class="line">[21]             <a class="code hl_define" href="qpc__qs_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END</a>()</div>
<div class="line">                 break;</div>
<div class="line">             }</div>
<div class="line">             default:</div>
<div class="line">                 break;</div>
<div class="line">         }</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* unused parameters... */</span></div>
<div class="line">         (<span class="keywordtype">void</span>)param1;</div>
<div class="line">         (<span class="keywordtype">void</span>)param2;</div>
<div class="line">         (<span class="keywordtype">void</span>)param3;</div>
<div class="line">     }</div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">     <span class="comment">/* host callback function to &quot;massage&quot; the event, if necessary */</span></div>
<div class="line">[22] <span class="keywordtype">void</span> <a class="code hl_function" href="qpc__qs_8h.html#ad3f890b82210f9d63348d9764bdc1073">QS_onTestEvt</a>(QEvt *e) {</div>
<div class="line">         (void)e;</div>
<div class="line"><span class="preprocessor">     #ifdef Q_HOST  </span><span class="comment">/* is this test compiled for a desktop Host computer? */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">     #else </span><span class="comment">/* this test is compiled for an embedded Target system */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">     #endif</span></div>
<div class="line">     }</div>
<div class="line">     <span class="comment">/*..........................................................................*/</span><span class="comment"></span></div>
<div class="line"><span class="comment">     /*! callback function to output the posted QP events (not used here) */</span></div>
<div class="line">[23] <span class="keywordtype">void</span> <a class="code hl_function" href="qpc__qs_8h.html#a14579f8a23d950a5f2393fa3f9b0e145">QS_onTestPost</a>(<span class="keywordtype">void</span> <span class="keyword">const</span> *sender, QActive *recipient,</div>
<div class="line">                        QEvt <span class="keyword">const</span> *e, <span class="keywordtype">bool</span> status)</div>
<div class="line">     {</div>
<div class="line">         (void)sender;</div>
<div class="line">         (void)recipient;</div>
<div class="line">         (void)e;</div>
<div class="line">         (void)status;</div>
<div class="line">     }</div>
<div class="ttc" id="aqpc__qs_8h_html_a034206ff7f20a4e6426a5f554434643b"><div class="ttname"><a href="qpc__qs_8h.html#a034206ff7f20a4e6426a5f554434643b">QS_OBJ_DICTIONARY</a></div><div class="ttdeci">#define QS_OBJ_DICTIONARY(obj_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01331">qpc_qs.h:1331</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a14579f8a23d950a5f2393fa3f9b0e145"><div class="ttname"><a href="qpc__qs_8h.html#a14579f8a23d950a5f2393fa3f9b0e145">QS_onTestPost</a></div><div class="ttdeci">void QS_onTestPost(void const *sender, QActive *recipient, QEvt const *e, bool status)</div></div>
<div class="ttc" id="aqpc__qs_8h_html_a2ed1002d3dda6d95f9f64c59b8453c71"><div class="ttname"><a href="qpc__qs_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END</a></div><div class="ttdeci">#define QS_END()</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01082">qpc_qs.h:1082</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a3b053b820c90aac6aa7e10adb76a18a5"><div class="ttname"><a href="qpc__qs_8h.html#a3b053b820c90aac6aa7e10adb76a18a5">QS_U16</a></div><div class="ttdeci">#define QS_U16(width_, data_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01151">qpc_qs.h:1151</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a3b1ab21c174f2bec448edec8865a8529"><div class="ttname"><a href="qpc__qs_8h.html#a3b1ab21c174f2bec448edec8865a8529">QS_FUN_DICTIONARY</a></div><div class="ttdeci">#define QS_FUN_DICTIONARY(fun_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01366">qpc_qs.h:1366</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a3d316077c13f8033c1a391590937e696"><div class="ttname"><a href="qpc__qs_8h.html#a3d316077c13f8033c1a391590937e696">QS_onTestSetup</a></div><div class="ttdeci">void QS_onTestSetup(void)</div></div>
<div class="ttc" id="aqpc__qs_8h_html_a43a3e7f568e445f82c0be2ebf924654c"><div class="ttname"><a href="qpc__qs_8h.html#a43a3e7f568e445f82c0be2ebf924654c">QS_BEGIN_ID</a></div><div class="ttdeci">#define QS_BEGIN_ID(rec_, qs_id_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01069">qpc_qs.h:1069</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a48cec974671d01f280b2b1a33225d176"><div class="ttname"><a href="qpc__qs_8h.html#a48cec974671d01f280b2b1a33225d176">QS_USER</a></div><div class="ttdeci">@ QS_USER</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l00306">qpc_qs.h:306</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a7ad67719163eea844e44bee7f0478c0a"><div class="ttname"><a href="qpc__qs_8h.html#a7ad67719163eea844e44bee7f0478c0a">QS_STR</a></div><div class="ttdeci">#define QS_STR(str_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01186">qpc_qs.h:1186</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_a9342913835bccef5ded5a59d2712101a"><div class="ttname"><a href="qpc__qs_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN</a></div><div class="ttdeci">#define QS_FUN(fun_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01240">qpc_qs.h:1240</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_aa42d8bbc70e6069f9c55d87f76ec15b0"><div class="ttname"><a href="qpc__qs_8h.html#aa42d8bbc70e6069f9c55d87f76ec15b0">QS_GLB_FILTER</a></div><div class="ttdeci">#define QS_GLB_FILTER(rec_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l01038">qpc_qs.h:1038</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_abefe60a3ba6b11d5406bba4708a48f2d"><div class="ttname"><a href="qpc__qs_8h.html#abefe60a3ba6b11d5406bba4708a48f2d">QS_onTestTeardown</a></div><div class="ttdeci">void QS_onTestTeardown(void)</div></div>
<div class="ttc" id="aqpc__qs_8h_html_ac13b38c805940608cd78cbaa86d62aff"><div class="ttname"><a href="qpc__qs_8h.html#ac13b38c805940608cd78cbaa86d62aff">AP_OBJ</a></div><div class="ttdeci">@ AP_OBJ</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l00846">qpc_qs.h:846</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_ad3f890b82210f9d63348d9764bdc1073"><div class="ttname"><a href="qpc__qs_8h.html#ad3f890b82210f9d63348d9764bdc1073">QS_onTestEvt</a></div><div class="ttdeci">void QS_onTestEvt(QEvt *e)</div></div>
<div class="ttc" id="aqpc__qs_8h_html_ae7b17c3ad4c237e9e89693fea1690513"><div class="ttname"><a href="qpc__qs_8h.html#ae7b17c3ad4c237e9e89693fea1690513">QS_ALL_RECORDS</a></div><div class="ttdeci">@ QS_ALL_RECORDS</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l00283">qpc_qs.h:283</a></div></div>
<div class="ttc" id="aqpc__qs_8h_html_af22371611fe57862a37eb785debb7921"><div class="ttname"><a href="qpc__qs_8h.html#af22371611fe57862a37eb785debb7921">QS_INIT</a></div><div class="ttdeci">#define QS_INIT(arg_)</div><div class="ttdef"><b>Definition:</b> <a href="qpc__qs_8h_source.html#l00995">qpc_qs.h:995</a></div></div>
</div><!-- fragment --><dl class="tag">
<dt>1</dt>
<dd>The <code>"qpc.h"</code> header file contains the <a href="https://www.state-machine.com/qpc/">QP/C framework</a> API, which includes the QUTest interface. Typically, you need to include this header file in QUTest <a href="https://martinfowler.com/bliki/TestDouble.html" target="_blank" class="extern">test doubles</a>. <blockquote class="doxtable">
<p>&zwj;<b>NOTE:</b> for test fixtures based on the <a href="https://www.state-machine.com/qpcpp/">QP/C++ framework</a>, you need to include the <code>"qpcpp.h"</code> header file.  </p>
</blockquote>
</dd>
<dt>2</dt>
<dd>You also need to include the interface to the CUT, which is <code>my_strlen.h</code> in this case.  </dd>
<dt>3</dt>
<dd>The macro <code>Q_DEFINE_THIS_FILE</code> is needed for "DbC assertions" (they have nothing to do with "test assertions"). Later in this file, a "DbC assertion" is used to guard against failure in the initialization of the <a class="el" href="qs.html">QS</a> target-resident component (see step [7]).  </dd>
<dt>4</dt>
<dd>The variable <code>string</code> is used to control the parameter passed into the CUT. </dd>
<dt>5</dt>
<dd>A QUTest <em>test fixture</em> code needs the <code>main()</code> function, which has the usual structure of a QP/C application (and in fact in the more advanced tests it can be <em>the same</em> function as used by the actual QP/C application). But here, it contains the bare minimum function calls, as described below.  </dd>
<dt>6</dt>
<dd>The <code>main()</code> function must start with calling <code>QF_init()</code> to initialize the QP framework.  </dd>
<dt>7</dt>
<dd>Next, you need to initialize the <a class="el" href="qs.html">QS</a> target-resident component (<a class="el" href="qpc__qs_8h.html#af22371611fe57862a37eb785debb7921">QS_INIT()</a>). This macro is wrapped with the <a href="https://www.state-machine.com/qpc/qassert_8h.html#aa0c75140aa3855c94e453b06567dcc28" class="extern"><b>Q_ALLEGE()</b></a> assertion, which will fire if the QS initialization fails (in which case continuation of the test makes no sense).  </dd>
<dt>8-9</dt>
<dd>Next, you produce <a class="el" href="qs.html#qs_dict">QS dictionaries</a> for all functions you wish to test as well as objects you might need to inspect. <b>NOTE:</b> you need to do this so that the test scripts can refer to the functions and objects by the same symbolic names as the CUT/test-fixture.  </dd>
<dt>10</dt>
<dd>The <a class="el" href="qpc__qs_8h.html#aa42d8bbc70e6069f9c55d87f76ec15b0">QS_GLB_FILTER()</a> macro sets the <a class="el" href="qs.html#qs_global">global filter</a> in the Target. Here all output is enabled (<a class="el" href="qpc__qs_8h.html#ae7b17c3ad4c237e9e89693fea1690513">QS_ALL_RECORDS</a>).  </dd>
<dt>11</dt>
<dd>The QS_setCurrObj(AP_OBJ) function sets the "current Application Object" in the Target. Subsequently, commands sent to the Target from the test script will pertain to that "current Application Object".  </dd>
<dt>12</dt>
<dd>Finally, at the end of <code>main()</code> you need to call <code>QF_run()</code> to run the tests.  </dd>
<dt>13</dt>
<dd>The callback function <code><a class="el" href="qpc__qs_8h.html#a3d316077c13f8033c1a391590937e696">QS_onTestSetup()</a></code> allows you to include code that will be run at the beginning of each test. Here this simple CUT does not need any setup, but you still need to provide (an empty) implementation to satisfy the linker.  </dd>
<dt>14</dt>
<dd>The callback function <code><a class="el" href="qpc__qs_8h.html#abefe60a3ba6b11d5406bba4708a48f2d">QS_onTestTeardown()</a></code> allows you to include code that will be run at the end of each test. Here this simple CUT does not need any teardown, but you still need to provide (an empty) implementation to satisfy the linker.  </dd>
<dt>15</dt>
<dd>The callback function <code>QS_onCommand()</code> allows you to remotely execute commands inside the Target. Here is where you execute the CUT and report results back to QSPY.  </dd>
<dt>16</dt>
<dd>The command with <code>cmdId==0</code> will be used to call the <code>my_strlen()</code> CUT. <b>NOTE:</b> You can use other <code>cmdId</code>s to call other pieces of CUT or to provide different variants of calling the same CUT, as you see fit. Much of the art of writing <em>test fixtures</em> lies in constructing flexible remote commands that exercise your CUT.  </dd>
<dt>17</dt>
<dd>The <code>QS_BEGIN()</code> macro starts the <a class="el" href="qs.html#qs_app">application-specific</a> trace record that will report results of calling the <code>my_strlen()</code> CUT to the test script.  </dd>
<dt>18</dt>
<dd>The <code><a class="el" href="qpc__qs_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN()</a></code> macro sends the address of the function to the test script. This address will be converted to the name of the function, because the dictionary for this function has been generated in step 8.  </dd>
<dt>19</dt>
<dd>The <code><a class="el" href="qpc__qs_8h.html#a3b053b820c90aac6aa7e10adb76a18a5">QS_U16()</a></code> macro sends a 16-bit unsigned integer (<code>uint16_t</code>) to the test script. Here you output the return value from <code>my_strlen()</code>.  </dd>
<dt>20</dt>
<dd>The <code><a class="el" href="qpc__qs_8h.html#a7ad67719163eea844e44bee7f0478c0a">QS_STR()</a></code> macro sends a zero-terminated string to the test script. Here you output the argument passed to <code>my_strlen()</code>.  </dd>
<dt>21</dt>
<dd>The <code><a class="el" href="qpc__qs_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END()</a></code> macro ends the <a class="el" href="qs.html#qs_app">application-specific</a> trace record.  </dd>
<dt>22</dt>
<dd>The <code><a class="el" href="qpc__qs_8h.html#ad3f890b82210f9d63348d9764bdc1073">QS_onTestEvt()</a></code> callback function is not used in this test, but needs to be provided to satisfy the linker.  </dd>
<dt>23</dt>
<dd>The <code><a class="el" href="qpc__qs_8h.html#a14579f8a23d950a5f2393fa3f9b0e145">QS_onTestPost()</a></code> callback function is not used in this test, but needs to be provided to satisfy the linker.  </dd>
</dl>
<div style="clear:both;"></div><h1><a class="anchor" id="qutest_unity-script"></a>
Test Script</h1>
<p>A <b>test script</b> contains a group of related tests (a <em>"test group"</em>). The basic job of these tests is to send inputs to the <em>test fixture</em> running in the Target and to compare the <a class="el" href="qspy_text.html">QSPY textual output</a> produced with the <b>expectations</b> of the test. The following listing shows the <em>test script</em> (Python) for the Unity basic tests (file <span class="img file_py"><code>test_strlen.py</code></span>). The explanation section following the listing clarifies the interesting lines of code (lines starting with <code>[xx]</code> labels).</p>
<dl class="section remark"><dt>Remarks</dt><dd>Even though a <em>test script</em> uses <b>Python</b> under the hood, you don't need to be a Python expert to write effective test scripts. The actual set of commands that you use and need to know about forms a small <a class="el" href="qutest_script.html">Domain Specific Language (DSL) for unit testing</a>, which just happens to be implemented with Python as a command interpreter.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>The following test script performs the same tests as the Unity test fixture <span class="img file_c"><code>test_strlen.c</code></span> in the directory <span class="img folder"><code>qpc\examples\qutest\unity_strlen\qutest</code></span>.</dd></dl>
<div class="fragment"><div class="line"> [1] <span class="comment"># test-script for QUTest unit testing harness</span></div>
<div class="line">     <span class="comment"># see https://www.state-machine.com/qtools/qutest.html</span></div>
<div class="line"> </div>
<div class="line">     <span class="comment"># preambe...</span></div>
<div class="line"> [2] <span class="comment">#def on_reset():</span></div>
<div class="line"> [3] <span class="comment">#    expect_run()</span></div>
<div class="line"> [4] <span class="comment">#    current_obj(OBJ_AP,&quot;string&quot;)</span></div>
<div class="line"> </div>
<div class="line">     <span class="comment"># tests...</span></div>
<div class="line"> [5] test(<span class="stringliteral">&quot;my_strlen 0 for_empty_string&quot;</span>)</div>
<div class="line"> [6] poke(0,1,b<span class="stringliteral">&quot;\0&quot;</span>)</div>
<div class="line"> [7] command(0)</div>
<div class="line"> [8] expect(<span class="stringliteral">&quot;@timestamp USER+000 my_strlen 0 &#39;&#39;&quot;</span>)</div>
<div class="line"> [9] expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">[10] test(<span class="stringliteral">&quot;my_strlen n for various strings&quot;</span>, NORESET)</div>
<div class="line">     poke(0,1,b<span class="stringliteral">&quot;Foo\0&quot;</span>)</div>
<div class="line">     command(0)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp USER+000 my_strlen 3 Foo&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line">     poke(0,1,b<span class="stringliteral">&quot; Foo\0&quot;</span>)</div>
<div class="line">     command(0)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp USER+000 my_strlen 4  Foo&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">     test(<span class="stringliteral">&quot;my_strlen n for unprintable chars&quot;</span>, NORESET)</div>
<div class="line">     poke(0,1,b<span class="stringliteral">&quot;\tFoo\0&quot;</span>)</div>
<div class="line">     command(0)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp USER+000 my_strlen 4 \tFoo&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line">     poke(0,1,b<span class="stringliteral">&quot;\a\b\n\0&quot;</span>)</div>
<div class="line">     command(0)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp USER+000 my_strlen 3 \a\b\n&quot;</span>)</div>
<div class="line">     expect(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
</div><!-- fragment --><dl class="tag">
<dt>1</dt>
<dd>Lines starting with a pound sign ('#') or empty lines are comments which are ignored by QUTest.  </dd>
</dl>
<div style="clear:both;"></div><p><b>"preamble"</b> defines the on-reset code common to all tests in the group: </p><dl class="tag">
<dt>2</dt>
<dd>The function on_reset() is executed after Target reset.  </dd>
<dt>3</dt>
<dd>The <code>expect_run()</code> directive consumes the QF-RUN trace record produced after Target reset.  </dd>
<dt>4</dt>
<dd>The current_obj() command sets the "current object" of the application-specific kind (<code>OBJ_AP</code>) in the Target. Subsequent commands (such as poke() in the next step) will act on this "current object".  </dd>
</dl>
<div style="clear:both;"></div><p><b>"tests"</b> performs various tests: </p><dl class="tag">
<dt>5</dt>
<dd>The test() directive starts a test and gives it a name (in double quotes). The name of the test will be displayed as the test is executed and should be a quick reminder about the objective of this test. This test command also <a class="el" href="qutest_conc.html#qutest_reset">resets the Target</a>, which brings the Target into a well-defined initial state and produces the <a class="el" href="qs.html#qs_dict">QS dictionary records</a> (see <a class="el" href="qutest_unity.html#qutest_unity-fixture">test-fixture</a>[12]). <blockquote class="doxtable">
<p>&zwj;<b>NOTE:</b> The ability to perform the <b>full Target reset</b> is a unique feature of QUTest. Other unit testing frameworks, including Unity and CppUTest, don't reset the Target. They merely call the test <code>setup() / tearDown()</code> functions at the beginning and end of the test, respectively. QUTest also calls <code>onReset() / onSetup() / onTeardown()</code>, but obviously the full Target reset is a much better guarantee that the Target starts in exactly the same state.  </p>
</blockquote>
</dd>
<dt>6</dt>
<dd>The poke() directive pokes the specified "Application Current Object" starting with the specified offset from the beginning of the object in memory (which here is 0) with the data elements of size 4 (the second argument) with the data provided in the third argument <code>pack()</code> "pack("&lt;L", 0x5A5A)" into the previously established "Application Current Object".  </dd>
<dt>7</dt>
<dd>The command() directive causes the invocation of the <code>QS_onCommand()</code> callback inside the Target. The argument 0 is the <code>cmdId</code> parameter (see <a class="el" href="qutest_unity.html#qutest_unity-fixture">test-fixture</a>[16]). <b>NOTE:</b> The first parameter of command() "command" here is just a number (0), but it is also possible to use a <b>symbolic name</b> for the first parameter. This symbolic name will be looked up in the user dictionary (<a class="el" href="qpc__qs_8h.html#ae75893daa66c6d0b5a6dfb8f3fca1196">QS_USR_DICTIONARY()</a>).  </dd>
<dt>8</dt>
<dd>The expect() command represents an <b>expectation</b> of this "test assertion". This is the expected output generated by the <code>command(0)</code> command from the previous step. You need to consult the test fixture to determine what you should expect in this case. <b>NOTE:</b> the expected string starts with a number <code>0000000001</code>, which is the <a class="el" href="qs.html#qs_tstamp">Target Time-Stamp</a>. In QUTest, the "timestamp" simply counts all the QS trace records produced, so that you know that no entries have been lost. In the later tests you will see how you can count the steps <b>automatically</b> with the <code>@timestamp</code> placeholder.  </dd>
<dt>8</dt>
<dd>The test finishes with the expectation for the <code>Trg-Done QS_RX_COMMAND</code> trace record, which means that all output generated by command() has been generated.  </dd>
<dt>9</dt>
<dd>This expectation consumes the "Trg-Done QS_RX_COMMAND" trace record, which ensures that <em>all</em> output for this command has been produced.  </dd>
</dl>
<div style="clear:both;"></div><dl class="section attention"><dt>Attention</dt><dd>The QSPY host application limits the <a class="el" href="qs.html#qs_dict">QS dictionaries</a> to the <b>first 63 characters</b>. This means that longer names of functions or objects will be <b>truncated</b> to this limit. Please keep this limit in mind when choosing various names in your application.</dd></dl>
<h1><a class="anchor" id="qutest_unity-embed"></a>
Running the Test on Embedded Targets</h1>
<p>As mentioned in the initial description of this example, the directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_strlen\qutest</code></span> contains makefiles to build the code and run the tests on the embedded boards (TivaC LaunchPad from Texas Instruments and EFM32 Pearl-Gecko board from Silicon Labs). Both these boards open a virtual COM port on the machine they are attached to via the USB cable. This virtual COM port provides an ideal connection for the <a class="el" href="qs.html">QS communication</a> with the <a class="el" href="qspy.html">QSPY host utility</a>.</p>
<div class="image">
<img src="platforms.png" alt=""/>
<div class="caption">
Targets for running QUTests. From the left: host computer, TivaC LaunchPad and EFM32 Pearl-Gecko</div></div>
    <p>For example, to test the EFM32 Pearl-Gecko board (ARM Cortex-M4), open a command prompt (on Windows) and type:</p>
<pre class="fragment">qspy -c COM6
</pre><p>This will start the QSPY host utility with com-port connection to the embedded board. Of course, you need to adjust the serial port number to the actual number of the virtual COM port on your machine.</p>
<p>Next, open a <b>second</b> command prompt window and type:</p>
<pre class="fragment">cd C:\qp\qpc\examples\qutest\unity_strlen\qutest
make -f make_efm32
</pre><p>The rest of the test is then exactly the same as with the host executable described <a class="el" href="qutest_unity.html#qutest_unity-run">above</a>, except that the <a class="el" href="qutest_unity.html#qutest_unity-fixture">test fixture</a> runs on the embedded board.</p>
<p>To run the tests on the TivaC LaunchPad (TM4C123 board), you use the <code>make_tm4c123</code> in the last step.</p>
<p><br  />
 <span class="prev_button"><a class="el" href="qutest_tut.html">QUTest&trade; Tutorial</a></span><span class="next_button"><a class="el" href="qutest_mock.html">Unity Mock Example</a></span> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="qutest.html">QUTest&trade; Unit Testing Harness</a></li><li class="navelem"><a class="el" href="qutest_tut.html">QUTest&trade; Tutorial</a></li>
    <li class="footer">
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2023 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QTools 7.2.1</b> &nbsp;|&nbsp; Updated on Thu Jan 26 2023
<hr class="footer"/><address class="footer"><small>
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2023 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QTools 7.2.1</b> &nbsp;|&nbsp; Updated on Thu Jan 26 2023
</small></address>
    </li>
  </ul>
</div>
</body>
</html>
