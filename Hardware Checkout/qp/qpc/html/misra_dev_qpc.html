<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QP/C: Deviations in QP/C Source Code</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="ql-preview.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="ql-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
  <div id="projectlogo">
    <a href="https://www.state-machine.com" title="Quantum Leaps"><img alt="Logo" src="logo_ql.png"/></a>
  </div>
   <div id="projectname">
    QP/C
    &nbsp;<span id="projectnumber">7.2.1</span>
   </div>
   <div id="projectbrief">Real-Time Embedded Framework</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('misra_dev_qpc.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Deviations in QP/C Source Code </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><span class="prev_button"><a class="el" href="misra_mtx.html">MISRA Compliance Matrix</a></span><span class="next_button"><a class="el" href="misra_dev_app.html">Deviations in Application Code</a></span> </p>
<h1><a class="anchor" id="misra_per_qpc"></a>
Deviation Permits</h1>
<p>This section documents deviations from MISRA-C:2012 guidelines and provides the deviation permits for the <em>QP/C source code</em>.</p>
<p><a id="a53_PQPD4_9" name="a53_PQPD4_9"></a> </p><hr  />
<h2><a class="anchor" id="PQPD4_9"></a>
PQPD4_9</h2>
<p>Directive 4.9(A) A function should be used in preference to a function-like macro where they are interchangeable PCLP reports violation of this <em>advisory</em> MISRA directive for <em>every</em> function-like macro definition, but without deeper analysis whether the macro is actually <em>interchangeable with a function</em>. Therefore, most of the PCLP violation reports for Directive 4.9 are actually only diagnosis of a <em>possible</em> violation of this directive (message category 2 in Section 5.3.3 of <a class="el" href="misra.html#misra_ref">[MISRA3]</a>).</p>
<p>If you want different code between debug and release, then that's an ideal use case for the preprocessor. Then you're not leaving anything up to the compiler. You're guaranteed that only the Spy version will have the extra calls. This is how the standard <code>assert</code> works, too. Note that this will also drop the parameter computation. For example, if you have log(get_msg()) then the macro method will drop the call to get_msg() as well. This is probably desirable, but you need to be aware of it.</p>
<p><a id="a54_PQP08_7" name="a54_PQP08_7"></a> </p><hr  />
<h2><a class="anchor" id="PQP08_7"></a>
PQP08_7</h2>
<p>Rule 8.7(R) Objects shall be defined at block scope if they are only accessed from within a single function Deviation from this rule occurs occasionally in using QP assertion macros <a class="el" href="qassert_8h.html#a27042866331f49c9e9ff4f3ef459eaaf">Q_DEFINE_THIS_FILE</a> and <a class="el" href="qassert_8h.html#a302498d7d57ae4196cb0745ac65959ae">Q_DEFINE_THIS_MODULE</a> (the <code><a class="el" href="qassert_8h.html" title="Customizable and memory-efficient Design by Contract (DbC) for embedded systems.">qassert.h</a></code> file). To save memory, the file name string is defined only once in static variable ::Q_this_module_ and then subsequently reused in every assertion.</p>
<p>However, if only one assertion happens to be used in a given file scope, the variable ::Q_this_module_ could be demoted to block scope. But this would break again if another assertion would be added at a later time. Therefore, for the sake of maintainability the deviation is allowed in this particular context only. As for inline, that's entirely up to the compiler. The inline keyword itself is only a hint, it does not obligate the compiler to do anything.</p>
<p><a id="a55_PQP11_1" name="a55_PQP11_1"></a> </p><hr  />
<h2><a class="anchor" id="PQP11_1"></a>
PQP11_1</h2>
<p>Rule 11.1(R): Conversions shall not be performed between a pointer to a function and any other type</p>
<p><a id="a56_PQP11_3" name="a56_PQP11_3"></a> </p><hr  />
<h2><a class="anchor" id="PQP11_3"></a>
PQP11_3</h2>
<p>Rule 11.3(R): A cast should not be performed between a pointer type and an integral type</p>
<p>Deviation from this rule occurs only in the QS software tracing instrumentation (not in production code). The QS code needs to output pointers to functions and pointers to objects by means of the macros QS_FUN_, QS_OBJ_, respectively. The deviation is allowed only in the context of these macros.</p>
<p><a id="a57_PQP11_8" name="a57_PQP11_8"></a> </p><hr  />
<h2><a class="anchor" id="PQP11_8"></a>
PQP11_8</h2>
<p>Rule 11.8(R): A cast shall not remove any const or volatile qualification from the type pointer to by a pointer</p>
<p>QP/C code deviates from this rule only in the internal macros QF_EVT_REF_CTR_INC_, QF_EVT_REF_CTR_DEC_, and QF_EPOOL_PUT_, where the const qualification needs to be occasionally discarded. The discarding of const is always preceded by ensuring that a given event is indeed dynamic (by testing the <a class="el" href="struct_q_evt.html#a3b7d04bb1c330faa82e59b947370582b">QEvt.poolId_</a> member). Deviation from this rule is considered a better tradeoff for safety and design correctness than not using the const qualification for events at all.</p>
<p><a id="a58_PQP12_8" name="a58_PQP12_8"></a> </p><hr  />
<h2><a class="anchor" id="PQP12_8"></a>
PQP12_8</h2>
<p>Rule 12.8(R)/13.7(R)/14.1(R): The right-hand operand of a shift operator shall lie between zero and one less than the width in bits of the underlying type of the left-hand operand. Boolean operations whose results are invariant shall not be permitted. There shall be no unreachable code</p>
<p>Deviation from these rules occurs only in the QS software tracing instrumentation (not in production code) and is related to QS filters. Certain QS trace records don't use all the filters, which manifests itself as an excessive shift. The deviation is allowed only in the context of the macros QS_BEGIN_ and QS_BEGIN_NOCRIT_.</p>
<p><a id="a59_PQP12_13" name="a59_PQP12_13"></a> </p><hr  />
<h2><a class="anchor" id="PQP12_13"></a>
PQP12_13</h2>
<p>Rule 12.13(A): The increment (++) and decrement (&ndash;) operators should not be mixed with other operators in an expression</p>
<p>Deviation from this rule occurs only in the QS software tracing macro QS_TEC_ (not in production code).</p>
<p><a id="a60_PQP16_7:20A" name="a60_PQP16_7:20A"></a> </p><hr  />
<h2><a class="anchor" id="PQP16_7"></a>
A PQP16_7 A</h2>
<p>pointer parameter in a function prototype should be declared as pointer to const if the pointer is not used to modify the addressed object</p>
<p>Deviation from this rule occurs only in the standard “vanilla” and <a class="el" href="struct_q_k.html" title="QK preemptive non-blocking kernel.">QK</a> ports of QP/C (and perhaps in other ports that do not use the per-task stacks). For the sake of wide-range portability, the signature of the functions QActive_start() and Qactive_stop() cannot declare the stack parameter as const, so in this particular context the deviation is allowed.</p>
<p><a id="a61_PQP17_3" name="a61_PQP17_3"></a> </p><hr  />
<h2><a class="anchor" id="PQP17_3"></a>
PQP17_3</h2>
<p><code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code> shall not be applied to pointer types except where they point to the same array.</p>
<p>Deviation from this rule occurs in only one assertion in the QP/C code (file qmp_put.c). The precondition assertion checks that the returned pointer to memory block indeed comes from the memory pool to which it is being returned. If the block belongs to the pool, the pointer comparison is made within the same array, so the rule is actually not violated. The transgression occurs only if the block pointer is not in range. The assertion of pointer range proved to be very valuable in ensuring the system integrity and in this particular context the benefits outweigh the risk of deviating from the MISRA rule.</p>
<p><a id="a62_PQP17_4" name="a62_PQP17_4"></a> </p><hr  />
<h2><a class="anchor" id="PQP17_4"></a>
PQP17_4</h2>
<p>Array indexing shall be the only allowed form of pointer arithmetic.</p>
<p>Deviation from this rule is related to the general policy of the QP/C framework with respect to memory allocation. In QP/C, all memory (e.g., memory blocks or event queue buffers) is pre-allocated by the application code and then passed as pointer and size of the memory to the framework. Subsequently, the memory is accessed using array indexing, but from the original base pointer, not from a true array—hence the deviation from rule 17.4. The deviation form rule 17.4 is encapsulated in the QP/C internal macro QF_PTR_AT_(), and this context is allowed to deviate per this procedure.</p>
<p><a id="a63_PQP18_4" name="a63_PQP18_4"></a> </p><hr  />
<h2><a class="anchor" id="PQP18_4"></a>
PQP18_4</h2>
<p>Unions shall not be used.</p>
<p>For production code, deviation from this rule occurs in the QEP component in the data type QMAttr, which used to specify the private state machine attribute in the <a class="el" href="struct_q_msm.html" title="QM state machine implementation strategy.">QMsm</a> base class. The use of a union in this case is strictly encapsulated inside the QEP event processor code and is never accessed in the application-level code. The justification of deviating from the rule 18.4 are significant savings in RAM for every state machine in the system as well as backwards-compatibility with the classes <a class="el" href="struct_q_hsm.html" title="Hierarchical State Machine class.">QHsm</a> and QFsm. Deviation from this rule occurs also in the QS software tracing instrumentation (not in production code) and is related to serialization of floating point numbers. The deviation is allowed only in the context of the functions QS_f32 and QS_f64.</p>
<p><span class="prev_button"><a class="el" href="misra_mtx.html">MISRA Compliance Matrix</a></span><span class="next_button"><a class="el" href="misra_dev_app.html">Deviations in Application Code</a></span>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="misra.html">MISRA Compliance</a></li>
    <li class="footer">
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2023 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QP/C 7.2.1</b> &nbsp;|&nbsp; Updated on Sun Jan 15 2023
<hr class="footer"/><address class="footer"><small>
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2023 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QP/C 7.2.1</b> &nbsp;|&nbsp; Updated on Sun Jan 15 2023
</small></address>
    </li>
  </ul>
</div>
</body>
</html>
