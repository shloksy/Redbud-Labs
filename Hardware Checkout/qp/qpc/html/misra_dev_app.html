<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QP/C: Deviations in Application Code</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="ql-preview.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="ql-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
  <div id="projectlogo">
    <a href="https://www.state-machine.com" title="Quantum Leaps"><img alt="Logo" src="logo_ql.png"/></a>
  </div>
   <div id="projectname">
    QP/C
    &nbsp;<span id="projectnumber">7.2.1</span>
   </div>
   <div id="projectbrief">Real-Time Embedded Framework</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('misra_dev_app.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Deviations in Application Code </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><span class="prev_button"><a class="el" href="misra_dev_qpc.html">Deviations in QP/C Source Code</a></span><span class="next_button"><a class="el" href="misra_gcs.html">Guideline Compliance Summary (GCS)</a></span> </p>
<h1><a class="anchor" id="misra_per_app"></a>
Deviation Permits</h1>
<p>This section documents deviations from MISRA-C:2012 rules in the application-level code, which are caused by the QP/C framework design or implementation. This section also describes workarounds to avoid some deviations.</p>
<p><a id="a64_PQAD4_9" name="a64_PQAD4_9"></a> </p><hr  />
<h2><a class="anchor" id="PQAD4_9"></a>
PQAD4_9</h2>
<p>Directive 4.9(A) A function should be used in preference to a function-like macro where they are interchangeable</p>
<p>PCLP reports violation of this <em>advisory</em> MISRA directive for every function-like macro definition, but without deeper analysis whether the macro is actually <em>interchangeable with a function</em>. Therefore, most of the PCLP violation reports for Directive 4.9 are actually only diagnosis of a <em>possible</em> violation of this directive (message category 2 in Section 5.3.3 of <a class="el" href="misra.html#misra_ref">[MISRA3]</a>).</p>
<p><a id="a65_PQA01_4" name="a65_PQA01_4"></a> </p><hr  />
<h2><a class="anchor" id="PQA01_4"></a>
PQA01_4</h2>
<p>Rule 1.4(R) Emergent language features shall not be used: (_Generic, _Noreturn, _Atomic, _Alignas)</p>
<p>Deviation from this (Amendment-2) rule is isolated in the macro <a class="el" href="qassert_8h.html#a3c9a47863f0f4254858b3387335869cb">Q_NORETURN</a> and occurs only in the <a class="el" href="qassert_8h.html#a72c51c5e24611fbf76b9b5c1b285acda">Q_onAssert()</a> callback function. This function has explicit <code>_Noreturn</code> semantics because continuing after assertion failure is not allowed. Informing the compiler about this semantics can potentially lead to better code generation and diagnostics messages. The risk of of "undefined, unspecified or implementation-defined behavior" potentially associated with the <code>_Noreturn</code> emergent feature is deemed low in this case because the <a class="el" href="qassert_8h.html#a72c51c5e24611fbf76b9b5c1b285acda">Q_onAssert()</a> callback should make it impossible to continue, even if the <code>_Noreturn</code> semantics is not fully implemented.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="misra_gep.html#misra_pclp-qpc">The qpc.lnt PLCP file</a></dd></dl>
<p><a id="a66_PQA04_8" name="a66_PQA04_8"></a> </p><hr  />
<h2><a class="anchor" id="PQA04_8"></a>
PQA04_8</h2>
<p>Dir 4.8(A): If a pointer to a structure or union is never dereferenced within a translation unit, then the implementation of the object should be hidden</p>
<p><a id="a67_PQA10_3" name="a67_PQA10_3"></a> </p><hr  />
<h2><a class="anchor" id="PQA10_3"></a>
PQA10_3</h2>
<p>Rule 10.3(R): The value of an expression shall not be assigned to an object with a narrower essential type or a different essential type category</p>
<p><a id="a68_PQA11_1" name="a68_PQA11_1"></a> </p><hr  />
<h2><a class="anchor" id="PQA11_1"></a>
PQA11_1</h2>
<p>Rule 11.1(R): Conversions shall not be performed between a pointer to a function and any other type</p>
<p><a id="a69_PQA11_3" name="a69_PQA11_3"></a> </p><hr  />
<h2><a class="anchor" id="PQA11_3"></a>
PQA11_3</h2>
<p>Rule 11.3(R): A cast shall note be performed between a pointer to object type and a pointer to a different object type</p>
<p>The QP/C Applications deviate from this rule because of downcasting the generic event pointer (<a class="el" href="struct_q_evt.html" title="Event class.">QEvt</a> const *) to the specific event in the state machine code. The QP/C framework encapsulates this deviation in the macro <a class="el" href="qep_8h.html#a9f117cb1bc50e9ef4dcc933533ccdd7f">Q_EVT_CAST()</a>. The code snippet below shows a use case. Please note that the macro <a class="el" href="qep_8h.html#a9f117cb1bc50e9ef4dcc933533ccdd7f">Q_EVT_CAST()</a> does <em>not</em> cast the const away, so writing to the event pointer is not allowed. </p><div class="fragment"><div class="line"><span class="keywordflow">case</span> EAT_SIG: {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_define" href="qep_8h.html#a9f117cb1bc50e9ef4dcc933533ccdd7f">Q_EVT_CAST</a>(TableEvt)-&gt;philoNum == PHILO_ID(me)) . . .</div>
<div class="ttc" id="aqep_8h_html_a9f117cb1bc50e9ef4dcc933533ccdd7f"><div class="ttname"><a href="qep_8h.html#a9f117cb1bc50e9ef4dcc933533ccdd7f">Q_EVT_CAST</a></div><div class="ttdeci">#define Q_EVT_CAST(class_)</div><div class="ttdef"><b>Definition:</b> <a href="qep_8h_source.html#l00990">qep.h:990</a></div></div>
</div><!-- fragment --><p><a id="a70_PQA11_5" name="a70_PQA11_5"></a> </p><hr  />
<h2><a class="anchor" id="PQA11_5"></a>
PQA11_5</h2>
<p>Rule 11.5(A): A conversion should not be performed from pointer to void into pointer to object</p>
<p><a id="a71_PQA12_3" name="a71_PQA12_3"></a> </p><hr  />
<h2><a class="anchor" id="PQA12_3"></a>
PQA12_3</h2>
<p>Rule 12.3(A): The comma operator should not be used</p>
<p>The QP/C applications deviate from rules 11.1, and 12.10 by using the QP/C macros <a class="el" href="qep_8h.html#a6531b0ab582f41275f19d28ac91d9e4f">Q_STATE_CAST()</a>, <a class="el" href="qep_8h.html#a8f06cd90ba5060780fc61a4810e3eb50">Q_TRAN()</a>, and <a class="el" href="qep_8h.html#ad8abd2f7098c41ec464343d9d8f1eadc">Q_SUPER()</a>, which are needed for coding hierarchical state machines in QP/C. The macro <a class="el" href="qep_8h.html#a6531b0ab582f41275f19d28ac91d9e4f">Q_STATE_CAST()</a> deviates from MISRA-C rule 11.1, because it performs cast to (QStateHandler). Here is the definition of the <a class="el" href="qep_8h.html#a6531b0ab582f41275f19d28ac91d9e4f">Q_STATE_CAST()</a> macro (file <a class="el" href="qep_8h.html" title="QEP/C platform-independent public interface.">qep.h</a>):</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define Q_STATE_CAST(handler_)  ((QStateHandler)(handler_))</span></div>
</div><!-- fragment --><p>In the QP/C application code the macro <a class="el" href="qep_8h.html#a6531b0ab582f41275f19d28ac91d9e4f">Q_STATE_CAST()</a> is used only to cast from pointers to state-handler functions, which are all compatible with QStateHandler. For example, the constructor of a custom active object must call the constructor of the base class <a class="el" href="qf__qact_8c.html#a46598ffb8ff47458b05ffb37b6bf55a1">QActive_ctor()</a> with the pointer to the initial state handler function, like this:</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="qf__qact_8c.html#a46598ffb8ff47458b05ffb37b6bf55a1">QActive_ctor</a>(&amp;me-&gt;super, <a class="code hl_define" href="qep_8h.html#a6531b0ab582f41275f19d28ac91d9e4f">Q_STATE_CAST</a>(&amp;Philo_initial));</div>
<div class="ttc" id="aqep_8h_html_a6531b0ab582f41275f19d28ac91d9e4f"><div class="ttname"><a href="qep_8h.html#a6531b0ab582f41275f19d28ac91d9e4f">Q_STATE_CAST</a></div><div class="ttdeci">#define Q_STATE_CAST(handler_)</div><div class="ttdef"><b>Definition:</b> <a href="qep_8h_source.html#l01005">qep.h:1005</a></div></div>
<div class="ttc" id="aqf__qact_8c_html_a46598ffb8ff47458b05ffb37b6bf55a1"><div class="ttname"><a href="qf__qact_8c.html#a46598ffb8ff47458b05ffb37b6bf55a1">QActive_ctor</a></div><div class="ttdeci">void QActive_ctor(QActive *const me, QStateHandler const initial)</div><div class="ttdef"><b>Definition:</b> <a href="qf__qact_8c_source.html#l00101">qf_qact.c:101</a></div></div>
</div><!-- fragment --><p>The state-handler functions are compatible, because they have almost the same signatures and differ only in the type of the first argument “me”. However, the “me” argument is derived from the <a class="el" href="struct_q_hsm.html" title="Hierarchical State Machine class.">QHsm</a> base class (in the sense described in the Recipe “Simple Encapsulation and Inheritance in C” [QL-OOPC 02]), but the C compiler does not “know” about this relationship—hence the cast is necessary.</p>
<p>The need to deviate from the rule 11.1 is a consequence of using function pointers in conjunction with “inheritance of structures”, which are both fundamental to the QP/C framework. This, very particular, deviation from rule 11.1 is safe and is allowed only in the context of state-handler functions, which are related. Additionally, macros <a class="el" href="qep_8h.html#a8f06cd90ba5060780fc61a4810e3eb50">Q_TRAN()</a> and <a class="el" href="qep_8h.html#ad8abd2f7098c41ec464343d9d8f1eadc">Q_SUPER()</a> deviate from the rule 12.10 (comma operator use). This deviation is needed for encapsulation of state-machine concepts (transition and superstate, respectively).</p>
<p><a id="a72_PQA13_4" name="a72_PQA13_4"></a> </p><hr  />
<h2><a class="anchor" id="PQA13_4"></a>
PQA13_4</h2>
<p>Rule 13.4(A): The result of an assignment operator shall not be used</p>
<p><a id="a73_PQA19_2" name="a73_PQA19_2"></a> </p><hr  />
<h2><a class="anchor" id="PQA19_2"></a>
PQA19_2</h2>
<p>Rule 19.2(A): The union keyword should not be used</p>
<p>For production code, deviation from this rule occurs in the QEP component in the data type <code><a class="el" href="union_q_hsm_attr.html" title="Attribute of for the QHsm class (Hierarchical State Machine).">QHsmAttr</a></code>, which used to specify the private state machine attribute in the <a class="el" href="struct_q_msm.html" title="QM state machine implementation strategy.">QMsm</a> base class. The use of a union in this case is strictly encapsulated inside the QEP event processor code and is never accessed in the application-level code. The justification of deviating from the rule 18.4 are significant savings in RAM for every state machine in the system as well as backwards-compatibility with the class <a class="el" href="struct_q_hsm.html" title="Hierarchical State Machine class.">QHsm</a>.</p>
<p>Deviation from this rule occurs also in the QS software tracing instrumentation (not in production code) and is related to serialization of floating point numbers. The deviation is allowed only in the context of the functions QS_f32()) and QS_f64().</p>
<p><a id="a74_PQA20_10" name="a74_PQA20_10"></a> </p><hr  />
<h2><a class="anchor" id="PQA20_10"></a>
PQA20_10</h2>
<p>Rule 20.10(A): The <code>#</code> and <code>##</code> preprocessor operators should not be used</p>
<p><span class="prev_button"><a class="el" href="misra_dev_qpc.html">Deviations in QP/C Source Code</a></span><span class="next_button"><a class="el" href="misra_gcs.html">Guideline Compliance Summary (GCS)</a></span>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="misra.html">MISRA Compliance</a></li>
    <li class="footer">
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2023 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QP/C 7.2.1</b> &nbsp;|&nbsp; Updated on Sun Jan 15 2023
<hr class="footer"/><address class="footer"><small>
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2023 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QP/C 7.2.1</b> &nbsp;|&nbsp; Updated on Sun Jan 15 2023
</small></address>
    </li>
  </ul>
</div>
</body>
</html>
